name: NFR Tests

on:
  pull_request:
    branches: [develop, main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  nfr:
    name: NFR Scenarios
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run NFR Tests
        id: nfr
        run: |
          # Run NFR tests
          set +e
          go test -v -run TestNFRScenarios ./internal/mcp/... 2>&1 | tee nfr-output.txt
          TEST_EXIT=${PIPESTATUS[0]}
          set -e

          # Parse results - count all PASS/FAIL lines including subtests
          PASS=$(grep -c -- "--- PASS" nfr-output.txt) || PASS=0
          FAIL=$(grep -c -- "--- FAIL" nfr-output.txt) || FAIL=0
          TOTAL=$((PASS + FAIL))

          # Job summary
          echo "## ðŸ“Š NFR Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | $PASS |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | $FAIL |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY

          # Set outputs for PR comment
          echo "pass=$PASS" >> $GITHUB_OUTPUT
          echo "fail=$FAIL" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "exit_code=$TEST_EXIT" >> $GITHUB_OUTPUT

          exit $TEST_EXIT

      - name: Parse NFR metrics
        id: metrics
        if: always()
        run: |
          # Extract actual token counts and timings from test output
          # Format: tool_tier_actual_baseline_status

          cat > parse_nfr.py << 'EOF'
          import re

          rows = []

          with open("nfr-output.txt", "r") as f:
              content = f.read()

          # Parse: "searchSymbols_small: 3500 bytes (baseline: 3600, max: 3960) [1.234ms]"
          pattern = r'(\w+)_(\w+): (\d+) bytes \(baseline: (\d+), max: (\d+)\) \[([^\]]+)\]'
          for match in re.finditer(pattern, content):
              tool, tier, actual, baseline, max_allowed, timing = match.groups()
              actual, baseline, max_allowed = int(actual), int(baseline), int(max_allowed)
              diff_pct = ((actual - baseline) / baseline) * 100
              budget_pct = (actual / max_allowed) * 100 if max_allowed > 0 else 0

              if diff_pct >= 10:
                  status = "FAIL"
                  trend = f"â–² +{diff_pct:.1f}%"
              elif diff_pct >= 5:
                  status = "WARN"
                  trend = f"â–² +{diff_pct:.1f}%"
              elif diff_pct <= -5:
                  status = "OK"
                  trend = f"â–¼ {diff_pct:.1f}%"
              else:
                  status = "OK"
                  trend = f"{diff_pct:+.1f}%"

              rows.append({
                  "tool": tool, "tier": tier, "actual": actual,
                  "baseline": baseline, "max": max_allowed,
                  "diff_pct": diff_pct, "budget_pct": budget_pct,
                  "trend": trend, "timing": timing, "status": status
              })

          if rows:
              # Sort by regression severity
              rows.sort(key=lambda r: -r["diff_pct"])

              # Stats
              fails = [r for r in rows if r["status"] == "FAIL"]
              warns = [r for r in rows if r["status"] == "WARN"]
              total = len(rows)
              passed = total - len(fails)
              worst = rows[0]

              # Headline
              if fails:
                  print(f"## NFR Budget âŒ {len(fails)} failed\n")
              else:
                  print(f"## NFR Budget âœ… {passed} passed\n")

              # Worst regression line
              print(f"**Worst:** `{worst['tool']}/{worst['tier']}` {worst['trend']} ({worst['actual']:,}B) â€¢ **Budget:** {worst['budget_pct']:.0f}% of max  ")
              print("**Thresholds:** WARN â‰¥ +5% â€¢ FAIL â‰¥ +10%\n")

              # Summary counts
              print("| Failures | Warnings | Scenarios |")
              print("|---:|---:|---:|")
              print(f"| {len(fails)} | {len(warns)} | {total} |\n")

              # Needs attention (only FAIL/WARN rows)
              attention = fails + warns
              if attention:
                  print("### Needs attention")
                  print("| Scenario | Actual (B) | Î” vs base | Budget | Time |")
                  print("|---|---:|---:|---:|---:|")
                  for r in attention[:5]:
                      label = f"**{r['status']}**" if r["status"] == "FAIL" else r["status"]
                      print(f"| {r['tool']} / {r['tier']} | {r['actual']:,} | {r['trend']} {label} | {r['budget_pct']:.0f}% | {r['timing']} |")
                  print()

              # Full breakdown in details
              print("<details><summary>All scenarios</summary>\n")
              print("| Scenario | Actual (B) | Baseline (B) | Max (B) | Î” | Budget | Time |")
              print("|---|---:|---:|---:|---:|---:|---:|")
              for r in rows:
                  print(f"| {r['tool']} / {r['tier']} | {r['actual']:,} | {r['baseline']:,} | {r['max']:,} | {r['trend']} | {r['budget_pct']:.0f}% | {r['timing']} |")
              print("\n</details>")
          else:
              print("No token metrics found in output")
          EOF

          if ! python3 parse_nfr.py > nfr-table.md 2>&1; then
            echo "::warning::Failed to parse NFR metrics"
            echo "No metrics parsed" > nfr-table.md
          fi
          cat nfr-table.md

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let body = 'No NFR metrics available';
            try {
              body = fs.readFileSync('nfr-table.md', 'utf8');
            } catch (e) {}

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('NFR Budget')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload NFR results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nfr-results
          path: |
            nfr-output.txt
            nfr-table.md
          retention-days: 7
