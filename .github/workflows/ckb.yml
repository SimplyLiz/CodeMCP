name: CKB Analysis

on:
  pull_request:
    branches: [develop, main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  analyze:
    name: PR Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for analysis

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Build CKB
        run: go build -ldflags="-s -w" -o ckb ./cmd/ckb

      - name: Initialize CKB
        run: |
          ./ckb init
          if ! ./ckb index; then
            echo "::warning::Index generation failed, continuing with git-only analysis"
          fi

      - name: Run CKB Doctor
        run: ./ckb doctor

      - name: Analyze PR
        id: analyze
        run: |
          # Get PR analysis (use origin/ prefix for remote ref)
          if ! ./ckb pr-summary --base=origin/${{ github.base_ref }} > pr-analysis.json 2>pr-analysis-err.txt; then
            echo "::warning::PR analysis failed"
            cat pr-analysis-err.txt
            # Create empty JSON so downstream steps work
            echo '{"error": "analysis failed"}' > pr-analysis.json
          fi

          # Extract risk score if available
          if [ -f pr-analysis.json ]; then
            RISK=$(jq -r '.riskAssessment.level // "unknown"' pr-analysis.json) || RISK="unknown"
            echo "risk_level=$RISK" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            function buildDashboard(data) {
              const s = data.summary || {};
              const risk = data.riskAssessment || {};
              const modules = data.modulesAffected || [];
              const files = data.changedFiles || [];

              // Risk emoji and color
              const riskEmoji = {
                'high': 'üî¥',
                'medium': 'üü°',
                'low': 'üü¢'
              }[risk.level] || '‚ö™';

              // Header with risk level
              const header = '## CKB PR Analysis ' + riskEmoji + ' ' + (risk.level || 'unknown').toUpperCase();

              // Summary table
              const summaryTable = [
                '| Metric | Value |',
                '|--------|------:|',
                '| Files Changed | ' + (s.totalFiles || 0) + ' |',
                '| Lines Added | +' + (s.totalAdditions || 0).toLocaleString() + ' |',
                '| Lines Deleted | -' + (s.totalDeletions || 0).toLocaleString() + ' |',
                '| Modules Affected | ' + (s.totalModules || 0) + ' |',
                '| Hotspots Touched | ' + (s.hotspotsTouched || 0) + ' |',
                '| Languages | ' + (s.languages || []).join(', ') + ' |'
              ].join('\n');

              // Risk factors
              const factors = (risk.factors || []);
              const factorsList = factors.length > 0
                ? factors.map(function(f) { return '- ' + f; }).join('\n')
                : '_None identified_';

              // Modules at risk (high and medium only)
              const riskyModules = modules
                .filter(function(m) { return m.riskLevel === 'high' || m.riskLevel === 'medium'; })
                .slice(0, 8);

              let modulesTable = '';
              if (riskyModules.length > 0) {
                const moduleRows = riskyModules.map(function(m) {
                  const emoji = m.riskLevel === 'high' ? 'üî¥' : 'üü°';
                  return '| ' + emoji + ' `' + m.moduleId + '` | ' + m.filesChanged + ' | ' + m.riskLevel + ' |';
                });
                modulesTable = [
                  '',
                  '### Modules at Risk',
                  '',
                  '| Module | Files | Risk |',
                  '|--------|------:|------|',
                  moduleRows.join('\n')
                ].join('\n');
              }

              // Top hotspots
              const hotspots = files
                .filter(function(f) { return f.isHotspot; })
                .sort(function(a, b) { return (b.hotspotScore || 0) - (a.hotspotScore || 0); })
                .slice(0, 5);

              let hotspotsTable = '';
              if (hotspots.length > 0) {
                const hotspotRows = hotspots.map(function(f) {
                  return '| `' + f.path + '` | ' + (f.hotspotScore || 0).toFixed(1) + ' |';
                });
                hotspotsTable = [
                  '',
                  '<details>',
                  '<summary>üî• Top Hotspots (' + hotspots.length + ')</summary>',
                  '',
                  '| File | Score |',
                  '|------|------:|',
                  hotspotRows.join('\n'),
                  '',
                  '</details>'
                ].join('\n');
              }

              // Suggestions
              const suggestions = (risk.suggestions || []);
              let suggestionsSection = '';
              if (suggestions.length > 0) {
                suggestionsSection = [
                  '',
                  '<details>',
                  '<summary>üí° Suggestions</summary>',
                  '',
                  suggestions.map(function(s) { return '- ' + s; }).join('\n'),
                  '',
                  '</details>'
                ].join('\n');
              }

              return [
                header,
                '',
                summaryTable,
                '',
                '### Risk Factors',
                '',
                factorsList,
                modulesTable,
                hotspotsTable,
                suggestionsSection
              ].join('\n');
            }

            let body = '## CKB PR Analysis\n\nAnalysis not available';
            try {
              const raw = fs.readFileSync('pr-analysis.json', 'utf8');
              const data = JSON.parse(raw);
              if (data.error) {
                body = '## CKB PR Analysis ‚ö†Ô∏è\n\nAnalysis failed: ' + data.error;
              } else {
                body = buildDashboard(data);
              }
            } catch (e) {
              body = '## CKB PR Analysis ‚ö†Ô∏è\n\nCould not read analysis: ' + e.message;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(function(c) {
              return c.user.type === 'Bot' && c.body.includes('CKB PR Analysis');
            });

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ckb-analysis
          path: |
            pr-analysis.json
            pr-analysis-err.txt
          retention-days: 7
