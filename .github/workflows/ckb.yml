# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  CKB â€¢ Code Intelligence for Pull Requests                                   â•‘
# â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘
# â•‘  PR Comment (signal) â†’ Checks Tab (dashboard) â†’ Artifacts (raw data)         â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CKB

on:
  pull_request:
    branches: [develop, main]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_index:
        description: 'Force full reindex'
        type: boolean
        default: false

concurrency:
  group: ckb-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write  # Required for Check Run API

env:
  CKB_TIER: standard
  THRESHOLD_CYCLOMATIC: 15
  THRESHOLD_COGNITIVE: 20
  THRESHOLD_COUPLING: 0.7

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-${{ github.base_ref }}-${{ hashFiles('go.sum') }}
          restore-keys: ckb-${{ runner.os }}-

      - name: Build
        run: go build -ldflags="-s -w" -o ckb ./cmd/ckb

      - name: Index
        id: index
        run: |
          ./ckb init
          START=$(date +%s)
          if [ "${{ inputs.force_index }}" = "true" ]; then
            ./ckb index --force 2>/dev/null || true
            echo "mode=full" >> $GITHUB_OUTPUT
          else
            ./ckb index 2>/dev/null || true
            echo "mode=incremental" >> $GITHUB_OUTPUT
          fi
          echo "duration=$(($(date +%s)-START))" >> $GITHUB_OUTPUT
          ./ckb meta stats --format=json > stats.json 2>/dev/null || echo '{"symbolsIndexed":0}' > stats.json

      - name: Analyze
        run: |
          ./ckb pr-summary --base=origin/${{ github.base_ref }} --format=json > analysis.json 2>/dev/null || echo '{}' > analysis.json
          
          # Complexity
          echo '[]' > complexity.json
          for f in $(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(go|ts|js|py)$' | head -20); do
            [ -f "$f" ] && ./ckb complexity "$f" --format=json 2>/dev/null | jq --arg f "$f" '. + {file: $f}' >> complexity.tmp || true
          done
          [ -f complexity.tmp ] && jq -s '.' complexity.tmp > complexity.json 2>/dev/null || true
          
          # Coupling
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(go|ts|js|py)$' | tr '\n' ',' | sed 's/,$//')
          [ -n "$CHANGED" ] && ./ckb coupling --files="$CHANGED" --min-correlation=${{ env.THRESHOLD_COUPLING }} --format=json > coupling.json 2>/dev/null || echo '{"missingCoupled":[]}' > coupling.json
          
          # Contracts
          echo '{"breakingChanges":[]}' > contracts.json
          for c in $(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(proto|graphql)$' || true); do
            ./ckb contracts impact --path="$c" --format=json 2>/dev/null | jq -s 'add' >> contracts.tmp || true
          done
          [ -f contracts.tmp ] && jq -s '{breakingChanges: map(.breakingChanges // []) | add}' contracts.tmp > contracts.json 2>/dev/null || true
          
          # Other analyses
          ./ckb audit --min-score=60 --limit=20 --quick-wins --format=json > audit.json 2>/dev/null || echo '{"items":[],"quickWins":[]}' > audit.json
          ./ckb docs stale --all --format=json > stale.json 2>/dev/null || echo '{"totalStale":0,"reports":[]}' > stale.json
          ./ckb telemetry dead-code --threshold=0.9 --limit=10 --format=json > deadcode.json 2>/dev/null || echo '{"candidates":[]}' > deadcode.json
          ./ckb ownership drift --threshold=0.3 --limit=10 --format=json > drift.json 2>/dev/null || echo '[]' > drift.json
          ./ckb meta languages --format=json > languages.json 2>/dev/null || echo '{"languages":[]}' > languages.json
          ./ckb blast-radius --format=json > blast.json 2>/dev/null || echo '{"affectedSymbols":[],"affectedTests":[]}' > blast.json
          ./ckb audit --factor=security_sensitive --min-score=40 --limit=10 --format=json > security.json 2>/dev/null || echo '{"items":[]}' > security.json

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CHECK RUN + PR COMMENT + STEP SUMMARY
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Report
        uses: actions/github-script@v7
        env:
          CACHE_HIT: ${{ steps.cache.outputs.cache-hit == 'true' }}
          INDEX_MODE: ${{ steps.index.outputs.mode }}
          INDEX_TIME: ${{ steps.index.outputs.duration }}
        with:
          script: |
            const fs = require('fs');
            const read = (f, d) => { try { return JSON.parse(fs.readFileSync(f)); } catch { return d; } };
            
            // Load data
            const pr = read('analysis.json', {});
            const complexity = read('complexity.json', []);
            const coupling = read('coupling.json', {});
            const contracts = read('contracts.json', {});
            const audit = read('audit.json', {});
            const stale = read('stale.json', {});
            const deadcode = read('deadcode.json', {});
            const drift = read('drift.json', []);
            const languages = read('languages.json', {});
            const blast = read('blast.json', {});
            const stats = read('stats.json', {});
            const security = read('security.json', {});
            
            const s = pr.summary || {};
            const risk = pr.riskAssessment || {};
            const reviewers = pr.suggestedReviewers || [];
            const files = pr.changedFiles || [];
            const auditItems = audit.items || [];
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COUNTS (Adaptive - only show what matters)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const counts = {
              critical: auditItems.filter(i => i.riskLevel === 'critical').length,
              high: auditItems.filter(i => i.riskLevel === 'high').length,
              security: (security.items || []).filter(i => i.riskLevel === 'critical' || i.riskLevel === 'high').length,
              breaking: (contracts.breakingChanges || []).length,
              hotspots: files.filter(f => f.isHotspot).length,
              complex: complexity.filter(c => (c.cyclomatic||0) > ${{ env.THRESHOLD_CYCLOMATIC }} || (c.cognitive||0) > ${{ env.THRESHOLD_COGNITIVE }}).length,
              coupled: (coupling.missingCoupled || []).length,
              blast: (blast.affectedSymbols || []).length + (blast.affectedTests || []).length,
              modules: (pr.modulesAffected || []).filter(m => m.riskLevel === 'high' || m.riskLevel === 'medium').length,
              quickWins: (audit.quickWins || []).length,
              dead: (deadcode.candidates || []).length,
              stale: stale.totalStale || 0,
              drift: Array.isArray(drift) ? drift.length : 0,
              lang: (languages.languages || []).filter(l => (l.quality || 1) < 0.7).length
            };
            
            const totalIssues = Object.values(counts).reduce((a, b) => a + b, 0);
            const safetyPct = Math.max(0, Math.round((1 - (risk.score || 0)) * 100));
            const riskEmoji = { high: 'ğŸ”´', medium: 'ğŸŸ¡', low: 'ğŸŸ¢' }[risk.level] || 'âšª';
            
            // Progress bar
            const bar = (pct, w = 15) => {
              const safe = Math.round((pct / 100) * w), risky = w - safe;
              let b = 'ğŸŸ©'.repeat(safe);
              if (risky > 0) b += pct >= 70 ? 'ğŸŸ¨'.repeat(risky) : pct >= 40 ? 'ğŸŸ§'.repeat(Math.ceil(risky/2)) + 'ğŸŸ¨'.repeat(Math.floor(risky/2)) : 'ğŸŸ¥'.repeat(Math.ceil(risky/2)) + 'ğŸŸ§'.repeat(Math.floor(risky/2));
              return b;
            };
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PR COMMENT (Ultra-lean: ~15 lines, signal only)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let comment = ['<!-- ckb -->', ''];
            comment.push(`## ${riskEmoji} CKB Report`);
            comment.push('');
            comment.push(`| ${bar(safetyPct)} | **${safetyPct}%** safe | **${s.totalFiles || 0}** files | **+${s.totalAdditions || 0}** / **-${s.totalDeletions || 0}** |`);
            comment.push('|:-----|:-----|:-----|:-----|');
            comment.push('');
            
            // Compact issue badges (only non-zero)
            const badges = [];
            if (counts.critical) badges.push(`ğŸ”´ ${counts.critical}`);
            if (counts.high) badges.push(`ğŸŸ  ${counts.high}`);
            if (counts.security) badges.push(`ğŸ” ${counts.security}`);
            if (counts.breaking) badges.push(`ğŸ’¥ ${counts.breaking}`);
            if (counts.hotspots) badges.push(`ğŸ”¥ ${counts.hotspots}`);
            if (counts.complex) badges.push(`ğŸ“Š ${counts.complex}`);
            if (counts.coupled) badges.push(`ğŸ”— ${counts.coupled}`);
            if (counts.stale) badges.push(`ğŸ“š ${counts.stale}`);
            
            if (badges.length > 0) {
              comment.push(`> ${badges.join(' Â· ')}`);
            } else {
              comment.push('> âœ… All checks passed');
            }
            comment.push('');
            
            // Reviewers
            if (reviewers.length > 0) {
              const revs = reviewers.slice(0, 3).map(r => `${r.owner.startsWith('@') ? r.owner : '@' + r.owner} \`${Math.round((r.coverage || 0) * 100)}%\``).join(' Â· ');
              comment.push(`**Review:** ${revs}`);
              comment.push('');
            }
            
            // Link to Checks tab
            comment.push(`ğŸ“Š [**View Details**](${context.payload.pull_request.html_url}/checks) Â· `);
            comment.push(`<sub>${process.env.CACHE_HIT === 'true' ? 'ğŸ’¾' : 'ğŸ”„'} ${process.env.INDEX_MODE === 'incremental' ? 'âš¡' : 'ğŸ”¨'} ${process.env.INDEX_TIME}s Â· ${(stats.symbolsIndexed || 0).toLocaleString()} sym</sub>`);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CHECK RUN OUTPUT (Full dashboard, up to 65KB)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            let summary = [];
            summary.push(`## ${riskEmoji} Risk: **${(risk.level || 'unknown').toUpperCase()}** (${safetyPct}% safe)`);
            summary.push('');
            summary.push(`| Files | Changes | Modules | Hotspots | Issues |`);
            summary.push(`|------:|--------:|--------:|---------:|-------:|`);
            summary.push(`| ${s.totalFiles || 0} | +${s.totalAdditions || 0} / -${s.totalDeletions || 0} | ${s.totalModules || 0} | ${s.hotspotsTouched || 0} | ${totalIssues} |`);
            summary.push('');
            
            if (reviewers.length > 0) {
              summary.push('### ğŸ‘¥ Suggested Reviewers');
              reviewers.slice(0, 5).forEach(r => summary.push(`- **${r.owner}** â€” ${Math.round((r.coverage || 0) * 100)}% coverage (${r.reason || ''})`));
              summary.push('');
            }
            
            let detail = [];
            
            // Helper: render table with cap
            const table = (title, icon, items, headers, rowFn, cap = 10) => {
              if (!items.length) return;
              detail.push(`### ${icon} ${title}`);
              detail.push('');
              detail.push(headers);
              detail.push(headers.replace(/[^|]/g, '-').replace(/\|-/g, '|:').replace(/-\|/g, '-|'));
              items.slice(0, cap).forEach(i => detail.push(rowFn(i)));
              if (items.length > cap) detail.push(`| â€¦ | +${items.length - cap} more |  |  |`);
              detail.push('');
            };
            
            // Risk Audit
            const riskItems = auditItems.filter(i => i.riskLevel === 'critical' || i.riskLevel === 'high');
            table('Risk Audit', 'âš ï¸', riskItems, 
              '| Level | File | Score | Factor |',
              i => `| ${i.riskLevel === 'critical' ? 'ğŸ”´' : 'ğŸŸ '} | \`${i.file}\` | ${i.riskScore} | ${(i.factors || [])[0]?.factor || '-'} |`
            );
            
            // Security
            const secItems = (security.items || []).filter(i => i.riskLevel === 'critical' || i.riskLevel === 'high');
            table('Security Sensitive', 'ğŸ”', secItems,
              '| File | Score | Contains |',
              i => `| \`${i.file}\` | ${i.riskScore} | ${(i.factors || []).find(f => f.factor === 'security_sensitive')?.value || 'auth'} |`
            );
            
            // Breaking Changes
            table('Breaking Changes', 'ğŸ’¥', contracts.breakingChanges || [],
              '| Symbol | Change |',
              b => `| \`${b.symbol || b.name || '?'}\` | ${b.change || b.description || '?'} |`
            );
            
            // Complexity
            const complexItems = complexity.filter(c => (c.cyclomatic||0) > ${{ env.THRESHOLD_CYCLOMATIC }} || (c.cognitive||0) > ${{ env.THRESHOLD_COGNITIVE }});
            table('Complexity Violations', 'ğŸ“Š', complexItems,
              '| File | Cyclomatic | Cognitive | Functions |',
              c => `| \`${c.file}\` | ${c.cyclomatic || 0} | ${c.cognitive || 0} | ${(c.hotFunctions || []).join(', ') || '-'} |`
            );
            
            // Coupling
            table('Coupling Warnings', 'ğŸ”—', coupling.missingCoupled || [],
              '| Missing | Usually changes with | Correlation |',
              w => `| \`${w.file}\` | \`${w.coupledTo}\` | ${Math.round((w.correlation || w.couplingScore || 0) * 100)}% |`
            );
            
            // Hotspots
            const hotspots = files.filter(f => f.isHotspot);
            table('Hotspots', 'ğŸ”¥', hotspots,
              '| File | Churn Score |',
              h => `| \`${h.path}\` | ${(h.hotspotScore || 0).toFixed(2)} |`
            );
            
            // Blast Radius
            if ((blast.affectedSymbols || []).length || (blast.affectedTests || []).length) {
              detail.push('### ğŸ’£ Blast Radius');
              detail.push('');
              if ((blast.affectedSymbols || []).length) {
                detail.push('**Affected symbols:**');
                (blast.affectedSymbols || []).slice(0, 8).forEach(s => detail.push(`- \`${s.name || s}\``));
              }
              if ((blast.affectedTests || []).length) {
                detail.push('**Tests to update:**');
                (blast.affectedTests || []).slice(0, 8).forEach(t => detail.push(`- \`${t.name || t}\``));
              }
              detail.push('');
            }
            
            // Modules
            const riskyModules = (pr.modulesAffected || []).filter(m => m.riskLevel === 'high' || m.riskLevel === 'medium');
            table('Modules at Risk', 'ğŸ“¦', riskyModules,
              '| Module | Files | Risk |',
              m => `| \`${m.moduleId}\` | ${m.filesChanged} | ${m.riskLevel === 'high' ? 'ğŸ”´' : 'ğŸŸ¡'} |`
            );
            
            // Quick Wins
            table('Quick Wins', 'ğŸ’¡', audit.quickWins || [],
              '| Action | Target | Effort | Impact |',
              w => `| ${w.action} | \`${w.target}\` | ${w.effort === 'low' ? 'ğŸŸ¢' : w.effort === 'medium' ? 'ğŸŸ¡' : 'ğŸ”´'} | ${w.impact === 'high' ? 'ğŸŸ¢' : w.impact === 'medium' ? 'ğŸŸ¡' : 'ğŸ”´'} |`
            );
            
            // Dead Code
            table('Dead Code', 'ğŸ’€', deadcode.candidates || [],
              '| Symbol | Path | Confidence |',
              d => `| \`${d.name}\` | \`${d.path || '-'}\` | ${Math.round((d.confidence || 0) * 100)}% |`
            );
            
            // Stale Docs
            const staleItems = [];
            (stale.reports || []).forEach(r => (r.stale || []).forEach(s => staleItems.push({ doc: r.docPath, ...s })));
            table('Stale Documentation', 'ğŸ“š', staleItems,
              '| Document | Line | Reference | Reason |',
              s => `| \`${s.doc}\` | ${s.line} | ${s.rawText || '-'} | ${s.reason || '-'} |`, 15
            );
            
            // Ownership Drift
            table('Ownership Drift', 'ğŸ‘¤', Array.isArray(drift) ? drift : [],
              '| File | CODEOWNERS | Actual |',
              d => `| \`${d.path}\` | ${d.declaredOwner || '-'} | ${d.actualOwner || '-'} |`
            );
            
            // Language Quality
            const lowQualityLangs = (languages.languages || []).filter(l => (l.quality || 1) < 0.7);
            table('Language Issues', 'ğŸŒ', lowQualityLangs,
              '| Language | Quality | Issues |',
              l => `| ${l.name} | ${Math.round((l.quality || 0) * 100)}% | ${(l.issues || []).join(', ') || '-'} |`
            );
            
            // Risk Factors
            if ((risk.factors || []).length > 0) {
              detail.push('### ğŸ“‹ Risk Factors');
              detail.push('');
              (risk.factors || []).forEach(f => detail.push(`- ${f}`));
              detail.push('');
            }
            
            // Analytics
            detail.push('### ğŸ“ˆ Analytics');
            detail.push('');
            detail.push('| Metric | Value |');
            detail.push('|:-------|------:|');
            detail.push(`| Symbols indexed | ${(stats.symbolsIndexed || 0).toLocaleString()} |`);
            detail.push(`| Files indexed | ${(stats.filesIndexed || 0).toLocaleString()} |`);
            detail.push(`| Index time | ${process.env.INDEX_TIME}s |`);
            detail.push(`| Index mode | ${process.env.INDEX_MODE} |`);
            detail.push(`| Cache | ${process.env.CACHE_HIT === 'true' ? 'âœ… hit' : 'âŒ miss'} |`);
            detail.push('');
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CREATE/UPDATE CHECK RUN
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const conclusion = counts.critical > 0 ? 'failure' : counts.breaking > 0 || counts.security > 0 ? 'action_required' : counts.high > 0 ? 'neutral' : 'success';
            
            // Find existing check run
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
              check_name: 'CKB Analysis'
            });
            
            const checkParams = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'CKB Analysis',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: `${riskEmoji} ${(risk.level || 'unknown').toUpperCase()} risk â€” ${totalIssues} issues`,
                summary: summary.join('\n'),
                text: detail.join('\n')
              }
            };
            
            // Add annotations for top issues
            const annotations = [];
            
            // Security annotations
            secItems.slice(0, 5).forEach(item => {
              annotations.push({
                path: item.file,
                start_line: 1,
                end_line: 1,
                annotation_level: 'warning',
                message: `ğŸ” Security-sensitive code: ${(item.factors || []).find(f => f.factor === 'security_sensitive')?.value || 'auth'}`,
                title: 'Security Review Required'
              });
            });
            
            // Complexity annotations
            complexItems.slice(0, 5).forEach(item => {
              annotations.push({
                path: item.file,
                start_line: 1,
                end_line: 1,
                annotation_level: 'warning',
                message: `ğŸ“Š High complexity: cyclomatic=${item.cyclomatic || 0}, cognitive=${item.cognitive || 0}`,
                title: 'Complexity Warning'
              });
            });
            
            if (annotations.length > 0) {
              checkParams.output.annotations = annotations.slice(0, 50); // GitHub limit
            }
            
            if (checkRuns.check_runs.length > 0) {
              await github.rest.checks.update({
                ...checkParams,
                check_run_id: checkRuns.check_runs[0].id
              });
            } else {
              await github.rest.checks.create(checkParams);
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // POST/UPDATE PR COMMENT
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existing = comments.find(c => c.user.type === 'Bot' && c.body.includes('<!-- ckb -->'));
            const commentBody = comment.join('\n');
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // STEP SUMMARY (backup)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const stepSummary = [summary.join('\n'), '', '---', '', detail.join('\n')].join('\n');
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, stepSummary);

      - name: Request Reviewers
        if: always()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const data = JSON.parse(fs.readFileSync('analysis.json'));
              const reviewers = (data.suggestedReviewers || [])
                .map(r => r.owner)
                .filter(r => !r.startsWith('@') && r !== context.actor)
                .slice(0, 2);
              if (reviewers.length) {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  reviewers
                });
              }
            } catch {}

      - name: Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-${{ github.base_ref }}-${{ hashFiles('go.sum') }}

      - name: Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ckb-analysis
          path: "*.json"
          retention-days: 14

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NIGHTLY REFRESH
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  refresh:
    name: Refresh
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Refresh
        run: |
          go build -ldflags="-s -w" -o ckb ./cmd/ckb
          ./ckb init && ./ckb index --force
          ./ckb refresh-architecture --scope=all 2>/dev/null || true
          
          mkdir -p reports
          ./ckb hotspots --limit=50 --format=json > reports/hotspots.json 2>/dev/null || true
          ./ckb audit --min-score=40 --limit=50 --quick-wins --format=json > reports/audit.json 2>/dev/null || true
          ./ckb docs stale --all --format=json > reports/stale.json 2>/dev/null || true
          ./ckb meta stats --format=json > reports/stats.json 2>/dev/null || true
          
          echo "## ğŸ“Š CKB Nightly" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------:|" >> $GITHUB_STEP_SUMMARY
          echo "| Symbols | $(jq '.symbolsIndexed // 0' reports/stats.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”´ Critical | $(jq '.summary.critical // 0' reports/audit.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŸ  High | $(jq '.summary.high // 0' reports/audit.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“š Stale | $(jq '.totalStale // 0' reports/stale.json) |" >> $GITHUB_STEP_SUMMARY

      - uses: actions/cache/save@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-main-nightly

      - uses: actions/upload-artifact@v4
        with:
          name: ckb-nightly
          path: reports/
          retention-days: 30