# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  CKB â€¢ Code Intelligence for Pull Requests                                   â•‘
# â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â•‘
# â•‘  Risk Analysis â€¢ Complexity Gates â€¢ Coupling Detection â€¢ Smart Reviews       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CKB

on:
  pull_request:
    branches: [develop, main]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_index:
        description: 'Force full reindex'
        type: boolean
        default: false

concurrency:
  group: ckb-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  CKB_TIER: standard
  THRESHOLD_CYCLOMATIC: 15
  THRESHOLD_COGNITIVE: 20
  THRESHOLD_COUPLING: 0.7
  THRESHOLD_DOC_COVERAGE: 70
  THRESHOLD_EVAL_PASS_RATE: 0.90

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-${{ github.base_ref }}-${{ hashFiles('go.sum') }}
          restore-keys: ckb-${{ runner.os }}-

      - name: Build
        run: go build -ldflags="-s -w" -o ckb ./cmd/ckb

      - name: Index
        id: index
        run: |
          ./ckb init
          START=$(date +%s)
          if [ "${{ inputs.force_index }}" = "true" ]; then
            ./ckb index --force 2>/dev/null || true
            echo "mode=full" >> $GITHUB_OUTPUT
          else
            ./ckb index 2>/dev/null || true
            echo "mode=incremental" >> $GITHUB_OUTPUT
          fi
          END=$(date +%s)
          echo "duration=$((END-START))" >> $GITHUB_OUTPUT

      - name: Analyze
        id: analyze
        run: |
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # PR SUMMARY
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ./ckb pr-summary --base=origin/${{ github.base_ref }} --format=json > analysis.json 2>/dev/null || echo '{}' > analysis.json
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # COMPLEXITY ANALYSIS
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo '[]' > complexity.json
          rm -f complexity.tmp
          for f in $(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(go|ts|js|py)$' | head -15); do
            [ -f "$f" ] && ./ckb complexity "$f" --format=json 2>/dev/null | jq --arg f "$f" '. + {file: $f}' >> complexity.tmp || true
          done
          [ -f complexity.tmp ] && jq -s '.' complexity.tmp > complexity.json 2>/dev/null || echo '[]' > complexity.json
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # COUPLING ANALYSIS
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(go|ts|js|py)$' | tr '\n' ',' | sed 's/,$//')
          [ -n "$CHANGED" ] && ./ckb coupling --files="$CHANGED" --min-correlation=${{ env.THRESHOLD_COUPLING }} --format=json > coupling.json 2>/dev/null || echo '{"missingCoupled":[]}' > coupling.json
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # CONTRACT CHANGES (Proto, GraphQL, OpenAPI)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo '{"changed":false,"files":[],"breakingChanges":[],"consumers":[]}' > contracts.json
          CONTRACTS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(proto|graphql|yaml|json)$' | grep -E '(proto/|api/|graphql/|openapi/)' || true)
          if [ -n "$CONTRACTS" ]; then
            FILES_JSON=$(echo "$CONTRACTS" | jq -R -s 'split("\n") | map(select(length > 0))')
            
            # Check for breaking changes
            BREAKING='[]'
            for CONTRACT in $CONTRACTS; do
              IMPACT=$(./ckb contracts impact --path="$CONTRACT" --format=json 2>/dev/null || echo '{}')
              if [ -n "$(echo "$IMPACT" | jq '.breakingChanges // empty')" ]; then
                BREAKING=$(echo "$BREAKING" | jq --argjson b "$(echo "$IMPACT" | jq '.breakingChanges // []')" '. + $b')
              fi
            done
            
            echo "{\"changed\":true,\"files\":$FILES_JSON,\"breakingChanges\":$BREAKING,\"consumers\":[]}" > contracts.json
          fi
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # RISK AUDIT (8-Factor)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ./ckb audit --min-score=60 --limit=10 --quick-wins --format=json > audit.json 2>/dev/null || echo '{"items":[],"quickWins":[],"summary":{}}' > audit.json
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # DOCUMENTATION COVERAGE & STALENESS
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ./ckb docs index 2>/dev/null || true
          ./ckb docs coverage --format=json > docs.json 2>/dev/null || echo '{"coverage":0}' > docs.json
          ./ckb docs stale --all --format=json > stale.json 2>/dev/null || echo '{"totalStale":0,"reports":[]}' > stale.json
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # DEAD CODE DETECTION
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ./ckb telemetry dead-code --threshold=0.9 --limit=5 --format=json > deadcode.json 2>/dev/null || echo '{"candidates":[],"coverage":0}' > deadcode.json
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # OWNERSHIP DRIFT
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ./ckb ownership drift --threshold=0.3 --limit=5 --format=json > drift.json 2>/dev/null || echo '[]' > drift.json
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # EVAL SUITE (if fixtures exist)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if [ -d ".ckb/fixtures" ]; then
            ./ckb eval --fixtures=.ckb/fixtures --format=json > eval.json 2>/dev/null || echo '{"passed":0,"total":0,"results":[]}' > eval.json
          else
            echo '{"passed":0,"total":0,"results":[],"skipped":true}' > eval.json
          fi
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # LANGUAGE QUALITY
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ./ckb meta languages --format=json > languages.json 2>/dev/null || echo '{"languages":[],"overallQuality":1}' > languages.json
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # BLAST RADIUS (what might break)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ./ckb blast-radius --format=json > blast.json 2>/dev/null || echo '{"affectedSymbols":[],"affectedTests":[]}' > blast.json

      - name: Comment
        uses: actions/github-script@v7
        env:
          CACHE_HIT: ${{ steps.cache.outputs.cache-hit == 'true' }}
          INDEX_MODE: ${{ steps.index.outputs.mode }}
          INDEX_TIME: ${{ steps.index.outputs.duration }}
        with:
          script: |
            const fs = require('fs');
            const read = (f, d) => { try { return JSON.parse(fs.readFileSync(f)); } catch { return d; } };
            
            // Load all analysis data
            const pr = read('analysis.json', {});
            const complexity = read('complexity.json', []);
            const coupling = read('coupling.json', {});
            const contracts = read('contracts.json', {});
            const audit = read('audit.json', {});
            const docs = read('docs.json', {});
            const stale = read('stale.json', {});
            const deadcode = read('deadcode.json', {});
            const drift = read('drift.json', []);
            const evalResults = read('eval.json', {});
            const languages = read('languages.json', {});
            const blast = read('blast.json', {});
            
            // Extract data
            const s = pr.summary || {};
            const risk = pr.riskAssessment || {};
            const reviewers = pr.suggestedReviewers || [];
            const modules = pr.modulesAffected || [];
            const files = pr.changedFiles || [];
            const couplingWarnings = coupling.missingCoupled || [];
            const auditItems = audit.items || [];
            const quickWins = audit.quickWins || [];
            const deadCandidates = deadcode.candidates || [];
            const staleCount = stale.totalStale || 0;
            const breakingChanges = contracts.breakingChanges || [];
            const blastSymbols = blast.affectedSymbols || [];
            const blastTests = blast.affectedTests || [];
            const lowQualityLangs = (languages.languages || []).filter(l => (l.quality || 1) < 0.7);
            
            // Computed values
            const complexViolations = complexity.filter(c => 
              (c.cyclomatic || 0) > ${{ env.THRESHOLD_CYCLOMATIC }} || 
              (c.cognitive || 0) > ${{ env.THRESHOLD_COGNITIVE }}
            );
            const hotspots = files.filter(f => f.isHotspot);
            const criticalItems = auditItems.filter(i => i.riskLevel === 'critical');
            const highItems = auditItems.filter(i => i.riskLevel === 'high');
            const riskyModules = modules.filter(m => m.riskLevel === 'high' || m.riskLevel === 'medium');
            const docCoverage = docs.coverage || 0;
            const evalPassed = evalResults.passed || 0;
            const evalTotal = evalResults.total || 0;
            const evalSkipped = evalResults.skipped || false;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // BUILD THE COMMENT
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            const riskEmoji = { high: 'ğŸ”´', medium: 'ğŸŸ¡', low: 'ğŸŸ¢' }[risk.level] || 'âšª';
            const riskScore = risk.score || 0;
            const safetyPct = Math.round((1 - riskScore) * 100);
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // COLORFUL PROGRESS BAR FUNCTION
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function makeProgressBar(safetyPercent, width = 15) {
              const safe = Math.round((safetyPercent / 100) * width);
              const risky = width - safe;
              
              // Use colorful emoji for visual appeal
              // Green for safe, gradient to red for risky
              let bar = '';
              
              // Safe portion (green)
              bar += 'ğŸŸ©'.repeat(safe);
              
              // Risky portion (gradient based on how risky)
              if (risky > 0) {
                if (safetyPercent >= 70) {
                  // Mostly safe - use yellow for remaining
                  bar += 'ğŸŸ¨'.repeat(risky);
                } else if (safetyPercent >= 40) {
                  // Medium risk - use orange/yellow mix
                  bar += 'ğŸŸ§'.repeat(Math.ceil(risky / 2));
                  bar += 'ğŸŸ¨'.repeat(Math.floor(risky / 2));
                } else {
                  // High risk - use red/orange
                  bar += 'ğŸŸ¥'.repeat(Math.ceil(risky / 2));
                  bar += 'ğŸŸ§'.repeat(Math.floor(risky / 2));
                }
              }
              
              return bar;
            }
            
            let c = [];
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // HEADER
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            c.push('<!-- ckb -->');
            c.push('');
            c.push(`## ${riskEmoji} CKB Report`);
            c.push('');
            
            // Metrics bar
            const metricsBar = [
              `**${s.totalFiles || 0}** files`,
              `**+${s.totalAdditions || 0}** / **-${s.totalDeletions || 0}**`,
              `**${s.totalModules || 0}** modules`,
              `**${s.hotspotsTouched || 0}** hotspots`
            ].join(' Â· ');
            c.push(`> ${metricsBar}`);
            c.push('');
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // COLORFUL SAFETY BAR
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const progressBar = makeProgressBar(safetyPct, 15);
            const safetyLabel = safetyPct >= 70 ? `**${safetyPct}%** safe âœ“` : 
                               safetyPct >= 40 ? `**${safetyPct}%** safe` : 
                               `**${safetyPct}%** safe âš ï¸`;
            
            c.push(`| Health | ${progressBar} | ${safetyLabel} |`);
            c.push('|:-------|:-----|:-----|');
            c.push('');
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // ISSUES SUMMARY
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const issues = [];
            if (criticalItems.length) issues.push(`ğŸ”´ **${criticalItems.length}** critical`);
            if (highItems.length) issues.push(`ğŸŸ  **${highItems.length}** high risk`);
            if (hotspots.length) issues.push(`ğŸ”¥ **${hotspots.length}** hotspots`);
            if (complexViolations.length) issues.push(`ğŸ“Š **${complexViolations.length}** complex`);
            if (couplingWarnings.length) issues.push(`ğŸ”— **${couplingWarnings.length}** coupled`);
            if (breakingChanges.length) issues.push(`ğŸ’¥ **${breakingChanges.length}** breaking`);
            if (contracts.changed) issues.push(`ğŸ“œ contracts`);
            if (staleCount) issues.push(`ğŸ“š **${staleCount}** stale docs`);
            if (deadCandidates.length) issues.push(`ğŸ’€ **${deadCandidates.length}** dead code`);
            if (lowQualityLangs.length) issues.push(`ğŸŒ **${lowQualityLangs.length}** lang issues`);
            
            if (issues.length > 0) {
              c.push(`> âš ï¸ ${issues.join(' Â· ')}`);
              c.push('');
            } else {
              c.push('> âœ… **All checks passed** â€” No issues detected');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // REVIEWERS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (reviewers.length > 0) {
              const revList = reviewers.slice(0, 3).map(r => {
                const name = r.owner.startsWith('@') ? r.owner : `@${r.owner}`;
                const pct = Math.round((r.coverage || 0) * 100);
                return `${name} \`${pct}%\``;
              }).join(' Â· ');
              c.push(`**Suggested reviewers:** ${revList}`);
              c.push('');
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COLLAPSIBLE DETAILS SECTIONS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // RISK FACTORS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if ((risk.factors || []).length > 0) {
              c.push('<details>');
              c.push('<summary>ğŸ“‹ Risk factors</summary>');
              c.push('');
              c.push('| Factor |');
              c.push('|:-------|');
              risk.factors.forEach(f => c.push(`| ${f} |`));
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // RISK AUDIT
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (criticalItems.length + highItems.length > 0) {
              c.push('<details>');
              c.push(`<summary>âš ï¸ Risk audit Â· ${criticalItems.length} critical Â· ${highItems.length} high</summary>`);
              c.push('');
              c.push('| | File | Score | Factor |');
              c.push('|:-:|:-----|------:|:-------|');
              [...criticalItems, ...highItems].slice(0, 8).forEach(item => {
                const icon = item.riskLevel === 'critical' ? 'ğŸ”´' : 'ğŸŸ ';
                const factor = (item.factors || [])[0]?.factor || '';
                c.push(`| ${icon} | \`${item.file}\` | ${item.riskScore} | ${factor} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // BREAKING CHANGES
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (breakingChanges.length > 0) {
              c.push('<details open>');
              c.push(`<summary>ğŸ’¥ Breaking changes Â· ${breakingChanges.length} detected</summary>`);
              c.push('');
              c.push('| Symbol | Change |');
              c.push('|:-------|:-------|');
              breakingChanges.slice(0, 5).forEach(b => {
                c.push(`| \`${b.symbol || b.name || '?'}\` | ${b.change || b.description || '?'} |`);
              });
              c.push('');
              c.push('> âš ï¸ **Action required:** Coordinate with downstream consumers before merging');
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // BLAST RADIUS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (blastSymbols.length > 0 || blastTests.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ’£ Blast radius Â· ${blastSymbols.length} symbols Â· ${blastTests.length} tests affected</summary>`);
              c.push('');
              if (blastSymbols.length > 0) {
                c.push('**Affected symbols:**');
                blastSymbols.slice(0, 5).forEach(sym => c.push(`- \`${sym.name || sym}\``));
                c.push('');
              }
              if (blastTests.length > 0) {
                c.push('**Tests that may need updates:**');
                blastTests.slice(0, 5).forEach(t => c.push(`- \`${t.name || t}\``));
                c.push('');
              }
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // COMPLEXITY
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (complexViolations.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ“Š Complexity Â· ${complexViolations.length} violations</summary>`);
              c.push('');
              c.push('| File | Cyclomatic | Cognitive |');
              c.push('|:-----|----------:|----------:|');
              complexViolations.slice(0, 6).forEach(v => {
                const cyc = v.cyclomatic || 0;
                const cog = v.cognitive || 0;
                const cycIcon = cyc > ${{ env.THRESHOLD_CYCLOMATIC }} ? 'âš ï¸' : '';
                const cogIcon = cog > ${{ env.THRESHOLD_COGNITIVE }} ? 'âš ï¸' : '';
                c.push(`| \`${v.file}\` | ${cycIcon} ${cyc} | ${cogIcon} ${cog} |`);
              });
              c.push('');
              c.push(`> Thresholds: cyclomatic â‰¤ ${{ env.THRESHOLD_CYCLOMATIC }}, cognitive â‰¤ ${{ env.THRESHOLD_COGNITIVE }}`);
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // COUPLING
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (couplingWarnings.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ”— Coupling Â· ${couplingWarnings.length} files often change together</summary>`);
              c.push('');
              c.push('| Missing | Usually changes with | Correlation |');
              c.push('|:--------|:---------------------|------------:|');
              couplingWarnings.slice(0, 5).forEach(w => {
                const pct = Math.round((w.correlation || w.couplingScore || 0) * 100);
                c.push(`| \`${w.file}\` | \`${w.coupledTo}\` | ${pct}% |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // HOTSPOTS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (hotspots.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ”¥ Hotspots Â· ${hotspots.length} volatile files</summary>`);
              c.push('');
              c.push('| File | Churn Score |');
              c.push('|:-----|------------:|');
              hotspots.slice(0, 6).forEach(h => {
                const score = (h.hotspotScore || 0).toFixed(2);
                c.push(`| \`${h.path}\` | ${score} |`);
              });
              c.push('');
              c.push('> Files with high churn correlate with bugs. Consider extra review.');
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // CONTRACTS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (contracts.changed && (contracts.files || []).length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ“œ Contract changes Â· ${contracts.files.length} files</summary>`);
              c.push('');
              c.push('| File |');
              c.push('|:-----|');
              contracts.files.slice(0, 6).forEach(f => c.push(`| \`${f}\` |`));
              c.push('');
              if ((contracts.consumers || []).length > 0) {
                c.push('**Known consumers:**');
                contracts.consumers.forEach(con => {
                  const icon = con.confidence === 'high' ? 'ğŸ”´' : 'ğŸŸ¡';
                  c.push(`- ${icon} ${con.repo}`);
                });
                c.push('');
              }
              c.push('> âš ï¸ Verify downstream consumers are compatible');
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // MODULES AT RISK
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (riskyModules.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ“¦ Modules Â· ${riskyModules.length} at risk</summary>`);
              c.push('');
              c.push('| Module | Files | Risk |');
              c.push('|:-------|------:|:----:|');
              riskyModules.slice(0, 6).forEach(m => {
                const icon = m.riskLevel === 'high' ? 'ğŸ”´' : 'ğŸŸ¡';
                c.push(`| \`${m.moduleId}\` | ${m.filesChanged} | ${icon} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // QUICK WINS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (quickWins.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ’¡ Quick wins Â· ${quickWins.length} improvements</summary>`);
              c.push('');
              c.push('| Action | Target | Effort | Impact |');
              c.push('|:-------|:-------|:------:|:------:|');
              quickWins.slice(0, 5).forEach(w => {
                const effort = { low: 'ğŸŸ¢', medium: 'ğŸŸ¡', high: 'ğŸ”´' }[w.effort] || 'âšª';
                const impact = { low: 'ğŸŸ¢', medium: 'ğŸŸ¡', high: 'ğŸ”´' }[w.impact] || 'âšª';
                c.push(`| ${w.action} | \`${w.target}\` | ${effort} | ${impact} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // DEAD CODE
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (deadCandidates.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ’€ Dead code Â· ${deadCandidates.length} candidates</summary>`);
              c.push('');
              c.push('| Symbol | Last Seen | Confidence |');
              c.push('|:-------|:----------|:----------:|');
              deadCandidates.slice(0, 5).forEach(d => {
                const pct = Math.round((d.confidence || 0) * 100);
                const lastSeen = d.lastSeen ? new Date(d.lastSeen).toLocaleDateString() : 'never';
                c.push(`| \`${d.name}\` | ${lastSeen} | ${pct}% |`);
              });
              c.push('');
              c.push('> Based on runtime telemetry. Verify before removing.');
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // STALE DOCS
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (staleCount > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ“š Stale docs Â· ${staleCount} broken references</summary>`);
              c.push('');
              c.push('| Location | Reference |');
              c.push('|:---------|:----------|');
              (stale.reports || []).slice(0, 4).forEach(r => {
                (r.stale || []).slice(0, 2).forEach(s => {
                  c.push(`| \`${r.docPath}:${s.line}\` | ${s.rawText} |`);
                });
              });
              c.push('');
              c.push('> Documentation references symbols that may have been renamed or removed.');
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // OWNERSHIP DRIFT
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (Array.isArray(drift) && drift.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ‘¤ Ownership drift Â· ${drift.length} files</summary>`);
              c.push('');
              c.push('| File | CODEOWNERS | Actual (git-blame) |');
              c.push('|:-----|:-----------|:-------------------|');
              drift.slice(0, 5).forEach(d => {
                c.push(`| \`${d.path}\` | ${d.declaredOwner || 'â€”'} | ${d.actualOwner || 'â€”'} |`);
              });
              c.push('');
              c.push('> CODEOWNERS may need updating to match actual contributors.');
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // DOCUMENTATION COVERAGE
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (docCoverage > 0 || docCoverage < ${{ env.THRESHOLD_DOC_COVERAGE }}) {
              const docIcon = docCoverage >= ${{ env.THRESHOLD_DOC_COVERAGE }} ? 'âœ…' : 'âš ï¸';
              c.push('<details>');
              c.push(`<summary>ğŸ“– Documentation Â· ${docIcon} ${docCoverage}% coverage</summary>`);
              c.push('');
              c.push(`| Coverage | Threshold | Status |`);
              c.push(`|:--------:|:---------:|:------:|`);
              c.push(`| ${docCoverage}% | ${{ env.THRESHOLD_DOC_COVERAGE }}% | ${docIcon} |`);
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // LANGUAGE QUALITY
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (lowQualityLangs.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸŒ Language quality Â· ${lowQualityLangs.length} issues</summary>`);
              c.push('');
              c.push('| Language | Quality | Issues |');
              c.push('|:---------|--------:|:-------|');
              lowQualityLangs.forEach(l => {
                const pct = Math.round((l.quality || 0) * 100);
                const issues = (l.issues || []).join(', ') || 'Unknown';
                c.push(`| ${l.name} | ${pct}% | ${issues} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // EVAL SUITE
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (!evalSkipped && evalTotal > 0) {
              const evalPct = Math.round((evalPassed / evalTotal) * 100);
              const evalIcon = evalPct >= (${{ env.THRESHOLD_EVAL_PASS_RATE }} * 100) ? 'âœ…' : 'âš ï¸';
              c.push('<details>');
              c.push(`<summary>ğŸ§ª Eval suite Â· ${evalIcon} ${evalPassed}/${evalTotal} passed (${evalPct}%)</summary>`);
              c.push('');
              c.push(`| Passed | Total | Rate | Threshold |`);
              c.push(`|:------:|:-----:|:----:|:---------:|`);
              c.push(`| ${evalPassed} | ${evalTotal} | ${evalPct}% | ${Math.round(${{ env.THRESHOLD_EVAL_PASS_RATE }} * 100)}% |`);
              c.push('');
              if ((evalResults.results || []).some(r => !r.passed)) {
                c.push('**Failed tests:**');
                (evalResults.results || []).filter(r => !r.passed).slice(0, 3).forEach(r => {
                  c.push(`- \`${r.id || r.name}\`: ${r.reason || 'failed'}`);
                });
                c.push('');
              }
              c.push('</details>');
              c.push('');
            }
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // FOOTER
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            c.push('---');
            const cacheStatus = process.env.CACHE_HIT === 'true' ? 'ğŸ’¾' : 'ğŸ”„';
            const indexMode = process.env.INDEX_MODE === 'incremental' ? 'âš¡' : 'ğŸ”¨';
            const indexTime = process.env.INDEX_TIME || '?';
            c.push(`<sub>${cacheStatus} ${indexMode} ${indexTime}s Â· [CKB](https://github.com/SimplyLiz/CodeMCP)</sub>`);
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // POST/UPDATE COMMENT
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const body = c.join('\n');
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existing = comments.find(comment => comment.user.type === 'Bot' && comment.body.includes('<!-- ckb -->'));
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      - name: Request Reviewers
        if: always()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const data = JSON.parse(fs.readFileSync('analysis.json'));
              const reviewers = (data.suggestedReviewers || [])
                .map(r => r.owner)
                .filter(r => !r.startsWith('@') && r !== context.actor)
                .slice(0, 2);
              
              if (reviewers.length) {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  reviewers
                });
              }
            } catch {}

      - name: Save Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-${{ github.base_ref }}-${{ hashFiles('go.sum') }}

      - name: Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ckb
          path: "*.json"
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # NIGHTLY REFRESH
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  refresh:
    name: Refresh
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Build & Refresh
        run: |
          go build -ldflags="-s -w" -o ckb ./cmd/ckb
          ./ckb init
          ./ckb index --force
          ./ckb refresh-architecture --scope=all 2>/dev/null || true
          
          mkdir -p reports
          ./ckb hotspots --limit=50 --format=json > reports/hotspots.json 2>/dev/null || true
          ./ckb audit --min-score=40 --limit=50 --quick-wins --format=json > reports/audit.json 2>/dev/null || true
          ./ckb docs coverage --format=json > reports/docs.json 2>/dev/null || true
          ./ckb meta languages --format=json > reports/languages.json 2>/dev/null || true
          
          # Run eval suite if fixtures exist
          if [ -d ".ckb/fixtures" ]; then
            ./ckb eval --fixtures=.ckb/fixtures --format=json > reports/eval.json 2>/dev/null || true
          fi
          
          echo "## ğŸ“Š CKB Nightly Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Hotspots | $(jq 'length' reports/hotspots.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $(jq '.summary.critical // 0' reports/audit.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| High Risk | $(jq '.summary.high // 0' reports/audit.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| Doc Coverage | $(jq '.coverage // 0' reports/docs.json 2>/dev/null || echo 0)% |" >> $GITHUB_STEP_SUMMARY
          if [ -f "reports/eval.json" ]; then
            PASSED=$(jq '.passed // 0' reports/eval.json)
            TOTAL=$(jq '.total // 0' reports/eval.json)
            echo "| Eval Suite | $PASSED / $TOTAL |" >> $GITHUB_STEP_SUMMARY
          fi

      - uses: actions/cache/save@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-main-nightly

      - uses: actions/upload-artifact@v4
        with:
          name: ckb-nightly
          path: reports/
          retention-days: 30