# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
# â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
# â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
# â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘    â•šâ–ˆâ–ˆâ•”â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
# â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
#  â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•     â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•â•â•â•â•â•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Code Intelligence for Pull Requests
# Features: Risk Scoring â€¢ Complexity Gates â€¢ Coupling Detection â€¢ Contract Analysis
#           Dead Code â€¢ Documentation Coverage â€¢ Ownership Drift â€¢ Auto-Reviewers
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CKB

on:
  pull_request:
    branches: [develop, main]
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force full reindex'
        type: boolean
        default: false

concurrency:
  group: ckb-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ THRESHOLDS - Adjust these for your project                              â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  COMPLEXITY_CYCLOMATIC: 15
  COMPLEXITY_COGNITIVE: 20
  COUPLING_MIN: 0.7
  DOC_COVERAGE_MIN: 70
  RISK_SCORE_MIN: 60

jobs:
  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘ PR ANALYSIS                                                              â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      risk: ${{ steps.summary.outputs.risk }}
      score: ${{ steps.summary.outputs.score }}
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Build
        run: go build -ldflags="-s -w" -o ckb ./cmd/ckb

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Cache & Index
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-${{ hashFiles('go.sum') }}-${{ github.base_ref }}
          restore-keys: ckb-${{ runner.os }}-

      - name: Index
        id: index
        run: |
          ./ckb init
          START=$(date +%s)
          
          if [ "${{ inputs.force }}" = "true" ]; then
            ./ckb index --force 2>/dev/null || true
            echo "mode=full" >> $GITHUB_OUTPUT
          elif ./ckb index 2>/dev/null; then
            echo "mode=incremental" >> $GITHUB_OUTPUT
          else
            echo "mode=fallback" >> $GITHUB_OUTPUT
          fi
          
          echo "duration=$(($(date +%s)-START))" >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Core Analysis
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: PR Summary
        id: summary
        run: |
          ./ckb pr-summary --base=origin/${{ github.base_ref }} --format=json > analysis.json 2>/dev/null || echo '{}' > analysis.json
          
          echo "risk=$(jq -r '.riskAssessment.level // "unknown"' analysis.json)" >> $GITHUB_OUTPUT
          echo "score=$(jq -r '.riskAssessment.score // 0' analysis.json)" >> $GITHUB_OUTPUT

      - name: Complexity
        id: complexity
        run: |
          echo '[]' > complexity.json
          
          for f in $(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(go|ts|js|py)$' | head -15); do
            [ -f "$f" ] || continue
            r=$(./ckb complexity "$f" --format=json 2>/dev/null || echo '{}')
            cy=$(echo "$r" | jq '.cyclomatic // 0')
            cg=$(echo "$r" | jq '.cognitive // 0')
            
            [ "$cy" -gt ${{ env.COMPLEXITY_CYCLOMATIC }} ] && \
              echo "::warning file=$f::Cyclomatic $cy > ${{ env.COMPLEXITY_CYCLOMATIC }}"
            [ "$cg" -gt ${{ env.COMPLEXITY_COGNITIVE }} ] && \
              echo "::warning file=$f::Cognitive $cg > ${{ env.COMPLEXITY_COGNITIVE }}"
            
            jq -n --arg f "$f" --argjson cy "$cy" --argjson cg "$cg" \
              '{file:$f,cyclomatic:$cy,cognitive:$cg}' >> complexity.json.tmp
          done
          
          [ -f complexity.json.tmp ] && jq -s '.' complexity.json.tmp > complexity.json || echo '[]' > complexity.json
          rm -f complexity.json.tmp
          
          echo "violations=$(jq '[.[] | select(.cyclomatic > ${{ env.COMPLEXITY_CYCLOMATIC }} or .cognitive > ${{ env.COMPLEXITY_COGNITIVE }})] | length' complexity.json)" >> $GITHUB_OUTPUT

      - name: Coupling
        id: coupling
        run: |
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(go|ts|js|py)$' | tr '\n' ',' | sed 's/,$//')
          
          if [ -n "$changed" ]; then
            ./ckb coupling --files="$changed" --min-correlation=${{ env.COUPLING_MIN }} --format=json > coupling.json 2>/dev/null || echo '{"missingCoupled":[]}' > coupling.json
          else
            echo '{"missingCoupled":[]}' > coupling.json
          fi
          
          echo "missing=$(jq '.missingCoupled | length' coupling.json)" >> $GITHUB_OUTPUT

      - name: Contracts
        id: contracts
        run: |
          echo '{"files":[],"breaking":[]}' > contracts.json
          
          contracts=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(proto|graphql)$' || true)
          
          if [ -n "$contracts" ]; then
            echo "$contracts" | jq -R -s 'split("\n") | map(select(length > 0)) | {files: ., breaking: []}' > contracts.json
            echo "::warning::Contract files changed: $(echo "$contracts" | tr '\n' ' ')"
          fi
          
          echo "changed=$([ -n "$contracts" ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Audit
        id: audit
        run: |
          ./ckb audit --min-score=${{ env.RISK_SCORE_MIN }} --limit=10 --quick-wins --format=json > audit.json 2>/dev/null || echo '{"items":[],"quickWins":[],"summary":{}}' > audit.json
          
          echo "critical=$(jq '.summary.critical // 0' audit.json)" >> $GITHUB_OUTPUT
          echo "high=$(jq '.summary.high // 0' audit.json)" >> $GITHUB_OUTPUT

      - name: Dead Code
        id: deadcode
        run: |
          ./ckb telemetry dead-code --threshold=0.9 --limit=5 --format=json > deadcode.json 2>/dev/null || echo '{"candidates":[]}' > deadcode.json
          echo "count=$(jq '.candidates | length' deadcode.json)" >> $GITHUB_OUTPUT

      - name: Docs
        id: docs
        run: |
          ./ckb docs index 2>/dev/null || true
          ./ckb docs coverage --format=json > docs-coverage.json 2>/dev/null || echo '{"coverage":0}' > docs-coverage.json
          ./ckb docs stale --all --format=json > docs-stale.json 2>/dev/null || echo '{"totalStale":0}' > docs-stale.json
          
          echo "coverage=$(jq '.coverage // 0' docs-coverage.json)" >> $GITHUB_OUTPUT
          echo "stale=$(jq '.totalStale // 0' docs-stale.json)" >> $GITHUB_OUTPUT

      - name: Drift
        run: |
          ./ckb ownership drift --threshold=0.3 --limit=5 --format=json > drift.json 2>/dev/null || echo '[]' > drift.json

      - name: Languages
        run: |
          ./ckb meta languages --format=json > languages.json 2>/dev/null || echo '{"languages":[],"overallQuality":1}' > languages.json

      - name: Eval
        run: |
          if [ -d ".ckb/fixtures" ]; then
            ./ckb eval --fixtures=.ckb/fixtures --format=json > eval.json 2>/dev/null || echo '{"passed":0,"total":0,"results":[]}' > eval.json
          else
            echo '{"passed":0,"total":0,"results":[],"skipped":true}' > eval.json
          fi

      - name: Blast Radius
        run: |
          ./ckb blast-radius --format=json > blast.json 2>/dev/null || echo '{"affectedSymbols":[],"affectedTests":[]}' > blast.json

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Report
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment
        uses: actions/github-script@v7
        env:
          CACHE_HIT: ${{ steps.cache.outputs.cache-hit }}
          INDEX_MODE: ${{ steps.index.outputs.mode }}
          INDEX_TIME: ${{ steps.index.outputs.duration }}
        with:
          script: |
            const fs = require('fs');
            const read = (f, d) => { try { return JSON.parse(fs.readFileSync(f)); } catch { return d; } };
            
            // Load data
            const pr = read('analysis.json', {});
            const complexity = read('complexity.json', []);
            const coupling = read('coupling.json', { missingCoupled: [] });
            const contracts = read('contracts.json', { files: [], breaking: [] });
            const audit = read('audit.json', { items: [], quickWins: [], summary: {} });
            const deadcode = read('deadcode.json', { candidates: [] });
            const docsCov = read('docs-coverage.json', { coverage: 0 });
            const docsStale = read('docs-stale.json', { totalStale: 0 });
            const drift = read('drift.json', []);
            const languages = read('languages.json', { languages: [], overallQuality: 1 });
            const evalResults = read('eval.json', { passed: 0, total: 0, results: [], skipped: true });
            const blast = read('blast.json', { affectedSymbols: [], affectedTests: [] });
            
            const s = pr.summary || {};
            const risk = pr.riskAssessment || {};
            const reviewers = pr.suggestedReviewers || [];
            const modules = pr.modulesAffected || [];
            const hotspots = (pr.changedFiles || []).filter(f => f.isHotspot);
            const breakingChanges = contracts.breaking || [];
            const blastSymbols = blast.affectedSymbols || [];
            const blastTests = blast.affectedTests || [];
            const lowQualityLangs = (languages.languages || []).filter(l => (l.quality || 1) < 0.7);
            
            // Computed
            const complexViolations = complexity.filter(c => 
              c.cyclomatic > ${{ env.COMPLEXITY_CYCLOMATIC }} || 
              c.cognitive > ${{ env.COMPLEXITY_COGNITIVE }}
            );
            const criticalItems = (audit.items || []).filter(i => i.riskLevel === 'critical');
            const highItems = (audit.items || []).filter(i => i.riskLevel === 'high');
            const riskyModules = modules.filter(m => m.riskLevel === 'high' || m.riskLevel === 'medium');
            
            // Helpers
            const pct = v => Math.round((v || 0) * 100);
            const safetyPct = Math.max(0, Math.round((1 - (risk.score || 0)) * 100));
            
            // Risk styling
            const riskStyle = {
              high: { icon: 'ğŸ”´', color: 'e74c3c', label: 'HIGH' },
              medium: { icon: 'ğŸŸ¡', color: 'f39c12', label: 'MEDIUM' },
              low: { icon: 'ğŸŸ¢', color: '27ae60', label: 'LOW' }
            }[risk.level] || { icon: 'âšª', color: '95a5a6', label: 'UNKNOWN' };
            
            // Colorful progress bar
            function makeProgressBar(safetyPercent, width = 15) {
              const p = Math.max(0, Math.min(100, safetyPercent));
              const safe = Math.round((p / 100) * width);
              const risky = width - safe;
              
              let bar = 'ğŸŸ©'.repeat(safe);
              if (risky > 0) {
                if (p >= 70) bar += 'ğŸŸ¨'.repeat(risky);
                else if (p >= 40) bar += 'ğŸŸ§'.repeat(Math.ceil(risky / 2)) + 'ğŸŸ¨'.repeat(Math.floor(risky / 2));
                else bar += 'ğŸŸ¥'.repeat(Math.ceil(risky / 2)) + 'ğŸŸ§'.repeat(Math.floor(risky / 2));
              }
              return bar;
            }
            
            // Build comment
            let c = [];
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // HEADER WITH BADGES
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            c.push('<!-- ckb -->');
            c.push('');
            c.push('## CKB Analysis');
            c.push('');
            c.push(`![Risk](https://img.shields.io/badge/${riskStyle.label}-${pct(risk.score)}%25-${riskStyle.color}?style=for-the-badge) ` +
                   `![Files](https://img.shields.io/badge/Files-${s.totalFiles || 0}-3498db?style=flat-square) ` +
                   `![Lines](https://img.shields.io/badge/%2B${s.totalAdditions || 0}%20%2F%20âˆ’${s.totalDeletions || 0}-3498db?style=flat-square) ` +
                   `![Modules](https://img.shields.io/badge/Modules-${s.totalModules || 0}-3498db?style=flat-square)`);
            c.push('');
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COLORFUL SAFETY BAR
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const progressBar = makeProgressBar(safetyPct, 15);
            const safetyLabel = safetyPct >= 70 ? `**${safetyPct}%** safe âœ“` : 
                               safetyPct >= 40 ? `**${safetyPct}%** safe` : 
                               `**${safetyPct}%** safe âš ï¸`;
            
            c.push(`| Health | ${progressBar} | ${safetyLabel} |`);
            c.push('|:-------|:-----|:-----|');
            c.push('');
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ISSUES SUMMARY
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const issues = [];
            if (criticalItems.length) issues.push(`ğŸ”´ **${criticalItems.length}** critical`);
            if (highItems.length) issues.push(`ğŸŸ  **${highItems.length}** high`);
            if (hotspots.length) issues.push(`ğŸ”¥ **${hotspots.length}** hotspots`);
            if (complexViolations.length) issues.push(`ğŸ“Š **${complexViolations.length}** complex`);
            if (coupling.missingCoupled?.length) issues.push(`ğŸ”— **${coupling.missingCoupled.length}** coupled`);
            if (breakingChanges.length) issues.push(`ğŸ’¥ **${breakingChanges.length}** breaking`);
            if (blastSymbols.length + blastTests.length) issues.push(`ğŸ’£ **${blastSymbols.length + blastTests.length}** blast`);
            if (contracts.files?.length) issues.push(`ğŸ“œ **${contracts.files.length}** contracts`);
            if (docsStale.totalStale) issues.push(`ğŸ“š **${docsStale.totalStale}** stale`);
            if (deadcode.candidates?.length) issues.push(`ğŸ’€ **${deadcode.candidates.length}** dead`);
            if (lowQualityLangs.length) issues.push(`ğŸŒ **${lowQualityLangs.length}** lang`);
            
            if (issues.length > 0) {
              c.push(`> âš ï¸ ${issues.join(' Â· ')}`);
              c.push('');
            } else {
              c.push('> âœ… **All checks passed** â€” No issues detected');
              c.push('');
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // RISK FACTORS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (risk.factors?.length) {
              c.push('**Risk factors:** ' + risk.factors.slice(0, 3).join(' â€¢ '));
              c.push('');
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // REVIEWERS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (reviewers.length) {
              const list = reviewers.slice(0, 3).map(r => {
                const name = r.owner.startsWith('@') ? r.owner : `@${r.owner}`;
                return `**${name}** (${pct(r.coverage)}%)`;
              }).join(', ');
              c.push(`ğŸ‘¥ **Suggested:** ${list}`);
              c.push('');
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // COLLAPSIBLE SECTIONS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Breaking Changes (open by default)
            if (breakingChanges.length > 0) {
              c.push('<details open>');
              c.push(`<summary>ğŸ’¥ Breaking changes Â· ${breakingChanges.length} detected</summary>`);
              c.push('');
              c.push('| Symbol | Change |');
              c.push('|:-------|:-------|');
              breakingChanges.slice(0, 5).forEach(b => {
                c.push(`| \`${b.symbol || b.name || '?'}\` | ${b.change || b.description || '?'} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Risk Audit
            if (criticalItems.length + highItems.length > 0) {
              c.push('<details>');
              c.push(`<summary>âš ï¸ Risk audit Â· ${criticalItems.length} critical Â· ${highItems.length} high</summary>`);
              c.push('');
              c.push('| | File | Score | Factor |');
              c.push('|:-:|:-----|------:|:-------|');
              [...criticalItems, ...highItems].slice(0, 6).forEach(item => {
                const icon = item.riskLevel === 'critical' ? 'ğŸ”´' : 'ğŸŸ ';
                const factor = (item.factors || [])[0]?.factor || 'â€”';
                c.push(`| ${icon} | \`${item.file}\` | ${item.riskScore} | ${factor} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Hotspots
            if (hotspots.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ”¥ Hotspots Â· ${hotspots.length} volatile files</summary>`);
              c.push('');
              c.push('| File | Churn |');
              c.push('|:-----|------:|');
              hotspots.slice(0, 5).forEach(f => {
                c.push(`| \`${f.path}\` | ${(f.hotspotScore || 0).toFixed(2)} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Modules
            if (riskyModules.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ“¦ Modules Â· ${riskyModules.length} at risk</summary>`);
              c.push('');
              c.push('| | Module | Files |');
              c.push('|:-:|:-------|------:|');
              riskyModules.slice(0, 5).forEach(m => {
                const icon = m.riskLevel === 'high' ? 'ğŸ”´' : 'ğŸŸ¡';
                c.push(`| ${icon} | \`${m.moduleId}\` | ${m.filesChanged} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Contracts
            if (contracts.files?.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ“œ Contracts Â· ${contracts.files.length} changed</summary>`);
              c.push('');
              contracts.files.slice(0, 6).forEach(f => c.push(`- \`${f}\``));
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Complexity
            if (complexViolations.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ“Š Complexity Â· ${complexViolations.length} violations</summary>`);
              c.push('');
              c.push('| File | Cyclomatic | Cognitive |');
              c.push('|:-----|----------:|----------:|');
              complexViolations.slice(0, 5).forEach(v => {
                const cyWarn = v.cyclomatic > ${{ env.COMPLEXITY_CYCLOMATIC }} ? 'âš ï¸ ' : '';
                const cgWarn = v.cognitive > ${{ env.COMPLEXITY_COGNITIVE }} ? 'âš ï¸ ' : '';
                c.push(`| \`${v.file}\` | ${cyWarn}${v.cyclomatic} | ${cgWarn}${v.cognitive} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Coupling
            if (coupling.missingCoupled?.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ”— Coupling Â· ${coupling.missingCoupled.length} missing</summary>`);
              c.push('');
              c.push('| Missing | Usually with | Score |');
              c.push('|:--------|:-------------|------:|');
              coupling.missingCoupled.slice(0, 5).forEach(w => {
                c.push(`| \`${w.file}\` | \`${w.coupledTo}\` | ${pct(w.correlation || w.couplingScore || 0)}% |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Quick Wins
            if (audit.quickWins?.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ’¡ Quick wins Â· ${audit.quickWins.length} suggestions</summary>`);
              c.push('');
              audit.quickWins.slice(0, 5).forEach(w => {
                const e = { low: 'ğŸŸ¢', medium: 'ğŸŸ¡', high: 'ğŸ”´' }[w.effort] || 'âšª';
                c.push(`- ${e} **${w.action}** â†’ \`${w.target}\``);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Ownership Drift
            if (Array.isArray(drift) && drift.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ‘¤ Ownership drift Â· ${drift.length} files</summary>`);
              c.push('');
              c.push('| File | Declared | Actual |');
              c.push('|:-----|:---------|:-------|');
              drift.slice(0, 5).forEach(d => {
                c.push(`| \`${d.path}\` | ${d.declaredOwner || 'â€”'} | ${d.actualOwner || 'â€”'} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Dead Code
            if (deadcode.candidates?.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ’€ Dead code Â· ${deadcode.candidates.length} candidates</summary>`);
              c.push('');
              c.push('| Symbol | Confidence |');
              c.push('|:-------|:-----------|');
              deadcode.candidates.slice(0, 5).forEach(d => {
                c.push(`| \`${d.name}\` | ${pct(d.confidence || 0)}% |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Stale Docs
            if (docsStale.totalStale > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ“š Stale docs Â· ${docsStale.totalStale} references</summary>`);
              c.push('');
              (docsStale.reports || []).slice(0, 3).forEach(r => {
                (r.stale || []).slice(0, 2).forEach(s => {
                  c.push(`- \`${r.docPath}:${s.line}\` â€” ${s.rawText}`);
                });
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Blast Radius
            if (blastSymbols.length > 0 || blastTests.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸ’£ Blast radius Â· ${blastSymbols.length} symbols Â· ${blastTests.length} tests</summary>`);
              c.push('');
              if (blastSymbols.length > 0) {
                c.push('**Affected symbols:**');
                blastSymbols.slice(0, 5).forEach(sym => c.push(`- \`${sym.name || sym}\``));
                c.push('');
              }
              if (blastTests.length > 0) {
                c.push('**Tests that may need updates:**');
                blastTests.slice(0, 5).forEach(t => c.push(`- \`${t.name || t}\``));
                c.push('');
              }
              c.push('</details>');
              c.push('');
            }
            
            // Language Quality
            if (lowQualityLangs.length > 0) {
              c.push('<details>');
              c.push(`<summary>ğŸŒ Language quality Â· ${lowQualityLangs.length} issues</summary>`);
              c.push('');
              c.push('| Language | Quality | Issues |');
              c.push('|:---------|--------:|:-------|');
              lowQualityLangs.slice(0, 5).forEach(l => {
                const quality = Math.round((l.quality || 0) * 100);
                const issues = (l.issues || []).join(', ') || 'â€”';
                c.push(`| ${l.name} | ${quality}% | ${issues} |`);
              });
              c.push('');
              c.push('</details>');
              c.push('');
            }
            
            // Eval Suite
            if (!evalResults.skipped && evalResults.total > 0) {
              const evalPassed = evalResults.passed || 0;
              const evalTotal = evalResults.total || 0;
              const evalPct = Math.round((evalPassed / evalTotal) * 100);
              const evalIcon = evalPct >= 90 ? 'âœ…' : 'âš ï¸';
              c.push('<details>');
              c.push(`<summary>ğŸ§ª Eval suite Â· ${evalIcon} ${evalPassed}/${evalTotal} passed (${evalPct}%)</summary>`);
              c.push('');
              c.push('| Passed | Total | Rate |');
              c.push('|:------:|:-----:|:----:|');
              c.push(`| ${evalPassed} | ${evalTotal} | ${evalPct}% |`);
              c.push('');
              const failed = (evalResults.results || []).filter(r => !r.passed);
              if (failed.length > 0) {
                c.push('**Failed tests:**');
                failed.slice(0, 3).forEach(r => {
                  c.push(`- \`${r.id || r.name}\`: ${r.reason || 'failed'}`);
                });
                c.push('');
              }
              c.push('</details>');
              c.push('');
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FOOTER
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            c.push('---');
            const cacheIcon = process.env.CACHE_HIT === 'true' ? 'ğŸ’¾' : 'ğŸ”„';
            const modeIcon = process.env.INDEX_MODE === 'incremental' ? 'âš¡' : 'ğŸ”¨';
            c.push(`<sub>${cacheIcon} ${modeIcon} ${process.env.INDEX_TIME || '?'}s Â· <a href="https://github.com/SimplyLiz/CodeMCP">CKB</a></sub>`);
            
            // Post/update comment
            const body = c.join('\n');
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const existing = comments.find(comment => comment.body?.includes('<!-- ckb -->'));
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Auto-Assign Reviewers
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Reviewers
        if: always()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const { suggestedReviewers = [] } = JSON.parse(fs.readFileSync('analysis.json'));
              const reviewers = suggestedReviewers
                .map(r => r.owner.replace(/^@/, ''))
                .filter(r => !r.includes('/') && r !== context.actor)
                .slice(0, 2);
              
              if (reviewers.length) {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  reviewers
                });
              }
            } catch {}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Artifacts
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Save Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-${{ hashFiles('go.sum') }}-${{ github.base_ref }}

      - name: Upload
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ckb-analysis
          path: '*.json'
          retention-days: 7

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘ SCHEDULED REFRESH                                                        â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  refresh:
    name: Refresh
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Build
        run: go build -ldflags="-s -w" -o ckb ./cmd/ckb

      - name: Cache
        uses: actions/cache@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-refresh-${{ github.run_id }}
          restore-keys: ckb-${{ runner.os }}-

      - name: Refresh
        run: |
          ./ckb init
          ./ckb index --force
          
          mkdir -p reports
          ./ckb hotspots --limit=50 --format=json > reports/hotspots.json 2>/dev/null || true
          ./ckb audit --min-score=40 --limit=50 --format=json > reports/audit.json 2>/dev/null || true
          ./ckb ownership drift --format=json > reports/drift.json 2>/dev/null || true

      - name: Summary
        run: |
          echo "## ğŸ“Š CKB Refresh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------:|" >> $GITHUB_STEP_SUMMARY
          echo "| Hotspots | $(jq 'length' reports/hotspots.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $(jq '.summary.critical // 0' reports/audit.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| High Risk | $(jq '.summary.high // 0' reports/audit.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| Drift | $(jq 'if type == "array" then length else 0 end' reports/drift.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ckb-refresh
          path: reports/
          retention-days: 30