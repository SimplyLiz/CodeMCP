name: CKB Analysis

on:
  pull_request:
    branches: [develop, main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  analyze:
    name: PR Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for analysis

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Restore CKB Cache
        uses: actions/cache@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-${{ github.base_ref }}-${{ hashFiles('go.sum') }}
          restore-keys: |
            ckb-${{ runner.os }}-${{ github.base_ref }}-
            ckb-${{ runner.os }}-

      - name: Build CKB
        run: go build -ldflags="-s -w" -o ckb ./cmd/ckb

      - name: Initialize CKB
        run: |
          ./ckb init
          if ! ./ckb index; then
            echo "::warning::Index generation failed, continuing with git-only analysis"
          fi

      - name: Analyze PR
        id: analyze
        run: |
          # Get PR analysis using CLI
          if ! ./ckb pr-summary --base=origin/${{ github.base_ref }} --format=json > pr-analysis.json 2>pr-analysis-err.txt; then
            echo "::warning::PR analysis failed"
            cat pr-analysis-err.txt
            echo '{"error": "analysis failed"}' > pr-analysis.json
          fi

          # Extract outputs
          RISK=$(jq -r '.riskAssessment.level // "unknown"' pr-analysis.json) || RISK="unknown"
          echo "risk_level=$RISK" >> $GITHUB_OUTPUT

      - name: Check Complexity
        id: complexity
        continue-on-error: true
        run: |
          echo '[]' > complexity-warnings.json
          WARNINGS='[]'

          for FILE in $(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(go|ts|js|py)$' | head -20); do
            if [ -f "$FILE" ]; then
              RESULT=$(./ckb complexity "$FILE" --format=json 2>/dev/null || echo '{}')
              CYCLO=$(echo "$RESULT" | jq '.cyclomatic // 0')
              COGNITIVE=$(echo "$RESULT" | jq '.cognitive // 0')

              if [ "$CYCLO" -gt 15 ] 2>/dev/null; then
                WARNINGS=$(echo "$WARNINGS" | jq --arg f "$FILE" --arg c "$CYCLO" '. + [{"file": $f, "type": "cyclomatic", "value": ($c | tonumber)}]')
              fi
              if [ "$COGNITIVE" -gt 20 ] 2>/dev/null; then
                WARNINGS=$(echo "$WARNINGS" | jq --arg f "$FILE" --arg c "$COGNITIVE" '. + [{"file": $f, "type": "cognitive", "value": ($c | tonumber)}]')
              fi
            fi
          done

          echo "$WARNINGS" > complexity-warnings.json
          COUNT=$(echo "$WARNINGS" | jq 'length')
          echo "warning_count=$COUNT" >> $GITHUB_OUTPUT

      - name: Check Coupling
        id: coupling
        continue-on-error: true
        run: |
          echo '[]' > coupling-warnings.json
          WARNINGS='[]'

          # Check each changed file for coupling
          for FILE in $(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(go|ts|js|py)$' | head -10); do
            if [ -f "$FILE" ]; then
              RESULT=$(./ckb coupling "$FILE" --min-correlation=0.7 --format=json 2>/dev/null || echo '{"coupled": []}')
              COUPLED=$(echo "$RESULT" | jq '.coupled // []')

              # Check if any coupled files are missing from the PR
              for COUPLED_FILE in $(echo "$COUPLED" | jq -r '.[].file // empty'); do
                if ! git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^${COUPLED_FILE}$"; then
                  SCORE=$(echo "$COUPLED" | jq -r --arg f "$COUPLED_FILE" '.[] | select(.file == $f) | .correlation // 0')
                  WARNINGS=$(echo "$WARNINGS" | jq --arg f "$COUPLED_FILE" --arg c "$FILE" --arg s "$SCORE" \
                    '. + [{"file": $f, "coupledTo": $c, "couplingScore": ($s | tonumber)}]')
                fi
              done
            fi
          done

          echo "$WARNINGS" > coupling-warnings.json
          COUNT=$(echo "$WARNINGS" | jq 'length')
          echo "warning_count=$COUNT" >> $GITHUB_OUTPUT

      - name: Check Ownership Drift
        id: drift
        continue-on-error: true
        run: |
          echo '[]' > ownership-drift.json

          RESULT=$(./ckb ownership drift --threshold=0.3 --limit=10 --format=json 2>/dev/null || echo '[]')
          echo "$RESULT" > ownership-drift.json

          COUNT=$(echo "$RESULT" | jq 'if type == "array" then length else 0 end')
          echo "drift_count=$COUNT" >> $GITHUB_OUTPUT

      - name: Run Risk Audit
        id: audit
        continue-on-error: true
        run: |
          echo '{"items": [], "quickWins": []}' > risk-audit.json

          RESULT=$(./ckb audit --min-score=60 --limit=10 --quick-wins --format=json 2>/dev/null || echo '{"items": [], "quickWins": []}')
          echo "$RESULT" > risk-audit.json

          CRITICAL=$(echo "$RESULT" | jq '.summary.critical // 0')
          HIGH=$(echo "$RESULT" | jq '.summary.high // 0')
          echo "critical_count=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH" >> $GITHUB_OUTPUT

      - name: Check Dead Code
        id: deadcode
        continue-on-error: true
        run: |
          echo '{"candidates": []}' > deadcode.json

          RESULT=$(./ckb telemetry dead-code --threshold=0.9 --limit=10 --format=json 2>/dev/null || echo '{"candidates": []}')
          echo "$RESULT" > deadcode.json

          COUNT=$(echo "$RESULT" | jq '.candidates | length // 0')
          echo "candidate_count=$COUNT" >> $GITHUB_OUTPUT

      - name: Check Doc Staleness
        id: docs
        continue-on-error: true
        run: |
          echo '{"totalStale": 0, "reports": []}' > doc-staleness.json

          # Index docs first
          ./ckb docs index 2>/dev/null || true

          RESULT=$(./ckb docs stale --all --format=json 2>/dev/null || echo '{"totalStale": 0, "reports": []}')
          echo "$RESULT" > doc-staleness.json

          STALE=$(echo "$RESULT" | jq '.totalStale // 0')
          echo "stale_count=$STALE" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read all analysis data
            let prData = {};
            let complexityWarnings = [];
            let couplingWarnings = [];
            let deadCode = { candidates: [] };
            let ownershipDrift = [];
            let riskAudit = { items: [], quickWins: [], summary: {} };
            let docStaleness = { totalStale: 0, reports: [] };

            try { prData = JSON.parse(fs.readFileSync('pr-analysis.json', 'utf8')); } catch {}
            try { complexityWarnings = JSON.parse(fs.readFileSync('complexity-warnings.json', 'utf8')); } catch {}
            try { couplingWarnings = JSON.parse(fs.readFileSync('coupling-warnings.json', 'utf8')); } catch {}
            try { deadCode = JSON.parse(fs.readFileSync('deadcode.json', 'utf8')); } catch {}
            try { ownershipDrift = JSON.parse(fs.readFileSync('ownership-drift.json', 'utf8')); } catch {}
            try { riskAudit = JSON.parse(fs.readFileSync('risk-audit.json', 'utf8')); } catch {}
            try { docStaleness = JSON.parse(fs.readFileSync('doc-staleness.json', 'utf8')); } catch {}

            // Post or update comment helper
            async function postComment(content) {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('## CKB'));
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: content
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: content
                });
              }
            }

            if (prData.error) {
              await postComment('## CKB\n\n> **Analysis failed:** ' + prData.error);
              return;
            }

            const s = prData.summary || {};
            const risk = prData.riskAssessment || {};
            const modules = prData.modulesAffected || [];
            const reviewers = prData.suggestedReviewers || [];
            const files = prData.changedFiles || [];

            // Helper: Create progress bar using Unicode blocks
            function progressBar(value, max, width = 10) {
              const filled = Math.round((value / max) * width);
              const empty = width - filled;
              return '`' + 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(empty) + '`';
            }

            // Helper: Format number compactly
            function fmt(n) {
              if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
              return String(n);
            }

            // Risk configuration
            const riskConfig = {
              high: { color: 'e74c3c', label: 'HIGH', icon: 'ğŸ”´' },
              medium: { color: 'f39c12', label: 'MEDIUM', icon: 'ğŸŸ¡' },
              low: { color: '27ae60', label: 'LOW', icon: 'ğŸŸ¢' }
            };
            const rc = riskConfig[risk.level] || { color: '95a5a6', label: 'UNKNOWN', icon: 'âšª' };

            // Collect findings for summary
            const auditItems = riskAudit.items || [];
            const criticalCount = auditItems.filter(i => i.riskLevel === 'critical').length;
            const highCount = auditItems.filter(i => i.riskLevel === 'high').length;
            const quickWins = riskAudit.quickWins || [];
            const hotspots = files.filter(f => f.isHotspot);
            const riskyModules = modules.filter(m => m.riskLevel === 'high' || m.riskLevel === 'medium');
            const staleCount = docStaleness.totalStale || 0;
            const deadCandidates = deadCode.candidates || [];

            // Build comment
            let sections = [];

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // HEADER - Clean banner with risk badge
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            sections.push('## CKB');
            sections.push('');
            sections.push('![Risk](https://img.shields.io/badge/Risk-' + rc.label + '-' + rc.color + '?style=flat-square) ' +
                         '![Files](https://img.shields.io/badge/Files-' + (s.totalFiles || 0) + '-blue?style=flat-square) ' +
                         '![Changes](https://img.shields.io/badge/Changes-' + fmt(s.totalAdditions || 0) + '%2F' + fmt(s.totalDeletions || 0) + '-blue?style=flat-square) ' +
                         '![Modules](https://img.shields.io/badge/Modules-' + (s.totalModules || 0) + '-blue?style=flat-square)');
            sections.push('');

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // QUICK STATS - Compact findings overview
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const findings = [];
            if (hotspots.length > 0) findings.push('ğŸ”¥ ' + hotspots.length + ' hotspot' + (hotspots.length > 1 ? 's' : ''));
            if (criticalCount + highCount > 0) findings.push('âš ï¸ ' + (criticalCount + highCount) + ' risk item' + (criticalCount + highCount > 1 ? 's' : ''));
            if (complexityWarnings.length > 0) findings.push('ğŸ“Š ' + complexityWarnings.length + ' complex');
            if (couplingWarnings.length > 0) findings.push('ğŸ”— ' + couplingWarnings.length + ' coupled');
            if (staleCount > 0) findings.push('ğŸ“š ' + staleCount + ' stale doc' + (staleCount > 1 ? 's' : ''));

            if (findings.length > 0) {
              sections.push('**Findings:** ' + findings.join(' Â· '));
              sections.push('');
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // RISK FACTORS - Only if present, as blockquote
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const factors = risk.factors || [];
            if (factors.length > 0) {
              sections.push('> ' + factors.map(f => 'â€¢ ' + f).join('<br>\n> '));
              sections.push('');
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SUGGESTED REVIEWERS - Prominent if present
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (reviewers.length > 0) {
              const reviewerBadges = reviewers.slice(0, 3).map(r => {
                const name = r.owner.startsWith('@') ? r.owner : '@' + r.owner;
                const pct = Math.round((r.coverage || 0) * 100);
                return name + ' (' + pct + '%)';
              });
              sections.push('**Suggested reviewers:** ' + reviewerBadges.join(', '));
              sections.push('');
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // DETAILS SECTIONS - Collapsible groups
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            // Risk Audit (critical/high items)
            const criticalItems = auditItems.filter(i => i.riskLevel === 'critical');
            const highItems = auditItems.filter(i => i.riskLevel === 'high');
            if (criticalItems.length > 0 || highItems.length > 0) {
              sections.push('<details>');
              sections.push('<summary>âš ï¸ <b>Risk Audit</b> â€” ' + criticalItems.length + ' critical, ' + highItems.length + ' high</summary>');
              sections.push('');
              sections.push('| | File | Score | Top Factor |');
              sections.push('|:--|:-----|------:|:-----------|');
              [...criticalItems, ...highItems].slice(0, 6).forEach(item => {
                const topFactor = (item.factors || [])[0];
                const factorStr = topFactor ? topFactor.factor : '';
                const icon = item.riskLevel === 'critical' ? 'ğŸ”´' : 'ğŸŸ ';
                sections.push('| ' + icon + ' | `' + item.file + '` | ' + item.riskScore + ' | ' + factorStr + ' |');
              });
              sections.push('');
              sections.push('</details>');
              sections.push('');
            }

            // Hotspots
            if (hotspots.length > 0) {
              sections.push('<details>');
              sections.push('<summary>ğŸ”¥ <b>Hotspots</b> â€” ' + hotspots.length + ' volatile file' + (hotspots.length > 1 ? 's' : '') + ' touched</summary>');
              sections.push('');
              sections.push('| File | Churn Score |');
              sections.push('|:-----|------------:|');
              hotspots.slice(0, 5).forEach(f => {
                const score = (f.hotspotScore || 0);
                const bar = progressBar(Math.min(score, 1), 1, 8);
                sections.push('| `' + f.path + '` | ' + bar + ' ' + score.toFixed(2) + ' |');
              });
              sections.push('');
              sections.push('</details>');
              sections.push('');
            }

            // Modules at Risk
            if (riskyModules.length > 0) {
              sections.push('<details>');
              sections.push('<summary>ğŸ“¦ <b>Modules at Risk</b> â€” ' + riskyModules.length + ' module' + (riskyModules.length > 1 ? 's' : '') + '</summary>');
              sections.push('');
              sections.push('| | Module | Files |');
              sections.push('|:--|:-------|------:|');
              riskyModules.slice(0, 5).forEach(m => {
                const icon = m.riskLevel === 'high' ? 'ğŸ”´' : 'ğŸŸ¡';
                sections.push('| ' + icon + ' | `' + m.moduleId + '` | ' + m.filesChanged + ' |');
              });
              sections.push('');
              sections.push('</details>');
              sections.push('');
            }

            // Quick Wins
            if (quickWins.length > 0) {
              sections.push('<details>');
              sections.push('<summary>ğŸ’¡ <b>Quick Wins</b> â€” ' + quickWins.length + ' improvement' + (quickWins.length > 1 ? 's' : '') + '</summary>');
              sections.push('');
              quickWins.slice(0, 5).forEach(w => {
                const effortIcon = w.effort === 'low' ? 'ğŸŸ¢' : w.effort === 'medium' ? 'ğŸŸ¡' : 'ğŸ”´';
                sections.push('- ' + effortIcon + ' **' + w.action + '** on `' + w.target + '`');
              });
              sections.push('');
              sections.push('</details>');
              sections.push('');
            }

            // Complexity Warnings
            if (complexityWarnings.length > 0) {
              sections.push('<details>');
              sections.push('<summary>ğŸ“Š <b>Complexity</b> â€” ' + complexityWarnings.length + ' warning' + (complexityWarnings.length > 1 ? 's' : '') + '</summary>');
              sections.push('');
              sections.push('| File | Type | Value |');
              sections.push('|:-----|:-----|------:|');
              complexityWarnings.forEach(w => {
                const threshold = w.type === 'cyclomatic' ? 15 : 20;
                const ratio = w.value / threshold;
                const icon = ratio > 1.5 ? 'ğŸ”´' : 'ğŸŸ¡';
                sections.push('| `' + w.file + '` | ' + w.type + ' | ' + icon + ' ' + w.value + ' |');
              });
              sections.push('');
              sections.push('</details>');
              sections.push('');
            }

            // Coupling Warnings
            if (couplingWarnings.length > 0) {
              sections.push('<details>');
              sections.push('<summary>ğŸ”— <b>Coupling</b> â€” ' + couplingWarnings.length + ' file' + (couplingWarnings.length > 1 ? 's' : '') + ' usually change together</summary>');
              sections.push('');
              sections.push('| Missing | Usually Changes With | Score |');
              sections.push('|:--------|:---------------------|------:|');
              couplingWarnings.slice(0, 5).forEach(w => {
                const pct = Math.round((w.couplingScore || 0) * 100);
                sections.push('| `' + w.file + '` | `' + w.coupledTo + '` | ' + pct + '% |');
              });
              sections.push('');
              sections.push('</details>');
              sections.push('');
            }

            // Ownership Drift
            if (Array.isArray(ownershipDrift) && ownershipDrift.length > 0) {
              sections.push('<details>');
              sections.push('<summary>ğŸ‘¤ <b>Ownership Drift</b> â€” ' + ownershipDrift.length + ' file' + (ownershipDrift.length > 1 ? 's' : '') + '</summary>');
              sections.push('');
              sections.push('| File | Declared | Actual |');
              sections.push('|:-----|:---------|:-------|');
              ownershipDrift.slice(0, 5).forEach(d => {
                sections.push('| `' + d.path + '` | ' + (d.declaredOwner || 'â€”') + ' | ' + (d.actualOwner || 'â€”') + ' |');
              });
              sections.push('');
              sections.push('</details>');
              sections.push('');
            }

            // Dead Code
            if (deadCandidates.length > 0) {
              sections.push('<details>');
              sections.push('<summary>ğŸ’€ <b>Dead Code</b> â€” ' + deadCandidates.length + ' candidate' + (deadCandidates.length > 1 ? 's' : '') + '</summary>');
              sections.push('');
              sections.push('| Symbol | Last Seen | Confidence |');
              sections.push('|:-------|:----------|:-----------|');
              deadCandidates.slice(0, 5).forEach(c => {
                const pct = Math.round((c.confidence || 0) * 100);
                const bar = progressBar(c.confidence || 0, 1, 6);
                sections.push('| `' + c.name + '` | ' + (c.lastSeen || 'never') + ' | ' + bar + ' ' + pct + '% |');
              });
              sections.push('');
              sections.push('</details>');
              sections.push('');
            }

            // Stale Documentation
            if (staleCount > 0) {
              const reports = docStaleness.reports || [];
              sections.push('<details>');
              sections.push('<summary>ğŸ“š <b>Stale Docs</b> â€” ' + staleCount + ' broken reference' + (staleCount > 1 ? 's' : '') + '</summary>');
              sections.push('');
              reports.slice(0, 4).forEach(r => {
                const staleRefs = (r.stale || []).slice(0, 2);
                staleRefs.forEach(ref => {
                  sections.push('- `' + r.docPath + ':' + ref.line + '` â€” ' + ref.rawText);
                });
              });
              sections.push('');
              sections.push('</details>');
              sections.push('');
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FOOTER
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            sections.push('---');
            sections.push('<sub>Generated by [CKB](https://github.com/anthropics/ckb) Â· [Docs](https://github.com/anthropics/ckb#readme)</sub>');

            await postComment(sections.join('\n'));

      - name: Auto-Request Reviewers
        if: always() && steps.analyze.outputs.risk_level != 'unknown'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const data = JSON.parse(fs.readFileSync('pr-analysis.json', 'utf8'));
              const reviewers = (data.suggestedReviewers || [])
                .map(r => r.owner)
                .filter(r => !r.startsWith('@'))  // Filter out teams
                .filter(r => r !== context.actor)  // Don't request PR author
                .slice(0, 2);

              if (reviewers.length > 0) {
                console.log('Requesting reviewers:', reviewers);
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  reviewers: reviewers
                });
              }
            } catch (e) {
              console.log('Could not request reviewers:', e.message);
            }

      - name: Save CKB Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-${{ github.base_ref }}-${{ hashFiles('go.sum') }}

      - name: Upload analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ckb-analysis
          path: |
            pr-analysis.json
            pr-analysis-err.txt
            complexity-warnings.json
            coupling-warnings.json
            deadcode.json
            ownership-drift.json
            risk-audit.json
            doc-staleness.json
          retention-days: 7
