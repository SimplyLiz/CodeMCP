# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
# â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•
# â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
# â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘    â•šâ–ˆâ–ˆâ•”â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘
# â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
#  â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•     â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•â•â•â•â•â•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Code Intelligence for Pull Requests
# Features: Risk Scoring â€¢ Complexity Gates â€¢ Coupling Detection â€¢ Contract Analysis
#           Dead Code â€¢ Documentation Coverage â€¢ Ownership Drift â€¢ Auto-Reviewers
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CKB

on:
  pull_request:
    branches: [develop, main]
  schedule:
    - cron: '0 3 * * *' # Daily 3 AM UTC
  workflow_dispatch:
    inputs:
      force:
        description: 'Force full reindex'
        type: boolean
        default: false

concurrency:
  group: ckb-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ THRESHOLDS - Adjust these for your project                              â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  COMPLEXITY_CYCLOMATIC: 15
  COMPLEXITY_COGNITIVE: 20
  COUPLING_MIN: 0.7
  DOC_COVERAGE_MIN: 70
  RISK_SCORE_MIN: 60

jobs:
  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘ PR ANALYSIS                                                              â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      risk: ${{ steps.summary.outputs.risk }}
      score: ${{ steps.summary.outputs.score }}
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Build
        run: go build -ldflags="-s -w" -o ckb ./cmd/ckb

      - name: Install SCIP indexer
        run: go install github.com/sourcegraph/scip-go/cmd/scip-go@latest

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Cache & Index
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-${{ hashFiles('go.sum') }}-${{ github.base_ref }}
          restore-keys: ckb-${{ runner.os }}-

      - name: Index
        id: index
        run: |
          ./ckb init

          # Check for language-specific indexer
          if ! ./ckb index 2>&1 | tee /tmp/index.log; then
            if grep -q "Indexer not found" /tmp/index.log; then
              echo "::error::SCIP indexer not installed. See install commands below."
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  INDEXER NOT FOUND                                                            â•‘"
              echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
              echo "â•‘  CKB requires a SCIP indexer for your language.                               â•‘"
              echo "â•‘                                                                               â•‘"
              echo "â•‘  Go:         go install github.com/sourcegraph/scip-go/cmd/scip-go@latest     â•‘"
              echo "â•‘  TypeScript: npm i -g @sourcegraph/scip-typescript                            â•‘"
              echo "â•‘  Python:     pip install scip-python                                          â•‘"
              echo "â•‘  Rust:       cargo install scip                                               â•‘"
              echo "â•‘                                                                               â•‘"
              echo "â•‘  Add the install step before 'ckb index' in your workflow.                    â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              exit 1
            fi
            echo "::error::Indexing failed. Check logs above."
            exit 1
          fi
          echo "mode=indexed" >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Core Analysis
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: PR Summary
        id: summary
        run: |
          ./ckb pr-summary --base=origin/${{ github.base_ref }} --format=json > analysis.json 2>/dev/null || echo '{}' > analysis.json
          
          echo "risk=$(jq -r '.riskAssessment.level // "unknown"' analysis.json)" >> $GITHUB_OUTPUT
          echo "score=$(jq -r '.riskAssessment.score // 0' analysis.json)" >> $GITHUB_OUTPUT

      - name: Complexity
        id: complexity
        run: |
          echo '[]' > complexity.json
          
          for f in $(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(go|ts|js|py)$' | head -15); do
            [ -f "$f" ] || continue
            r=$(./ckb complexity "$f" --format=json 2>/dev/null || echo '{}')
            cy=$(echo "$r" | jq '.cyclomatic // 0')
            cg=$(echo "$r" | jq '.cognitive // 0')
            
            [ "$cy" -gt ${{ env.COMPLEXITY_CYCLOMATIC }} ] && \
              echo "::warning file=$f::Cyclomatic $cy > ${{ env.COMPLEXITY_CYCLOMATIC }}"
            [ "$cg" -gt ${{ env.COMPLEXITY_COGNITIVE }} ] && \
              echo "::warning file=$f::Cognitive $cg > ${{ env.COMPLEXITY_COGNITIVE }}"
            
            jq -n --arg f "$f" --argjson cy "$cy" --argjson cg "$cg" \
              '{file:$f,cyclomatic:$cy,cognitive:$cg}' >> complexity.json.tmp
          done
          
          [ -f complexity.json.tmp ] && jq -s '.' complexity.json.tmp > complexity.json || echo '[]' > complexity.json
          rm -f complexity.json.tmp
          
          echo "violations=$(jq '[.[] | select(.cyclomatic > ${{ env.COMPLEXITY_CYCLOMATIC }} or .cognitive > ${{ env.COMPLEXITY_COGNITIVE }})] | length' complexity.json)" >> $GITHUB_OUTPUT

      - name: Coupling
        id: coupling
        run: |
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(go|ts|js|py)$' | tr '\n' ',' | sed 's/,$//')
          
          if [ -n "$changed" ]; then
            ./ckb coupling --files="$changed" --min-correlation=${{ env.COUPLING_MIN }} --format=json > coupling.json 2>/dev/null || echo '{"missingCoupled":[]}' > coupling.json
          else
            echo '{"missingCoupled":[]}' > coupling.json
          fi
          
          echo "missing=$(jq '.missingCoupled | length' coupling.json)" >> $GITHUB_OUTPUT

      - name: Contracts
        id: contracts
        run: |
          echo '{"files":[],"breaking":false}' > contracts.json
          
          contracts=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(proto|graphql)$' || true)
          
          if [ -n "$contracts" ]; then
            echo "$contracts" | jq -R -s 'split("\n") | map(select(length > 0)) | {files: ., breaking: false}' > contracts.json
            echo "::warning::Contract files changed: $(echo "$contracts" | tr '\n' ' ')"
          fi
          
          echo "changed=$([ -n "$contracts" ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Audit
        id: audit
        run: |
          ./ckb audit --min-score=${{ env.RISK_SCORE_MIN }} --limit=10 --quick-wins --format=json > audit.json 2>/dev/null || echo '{"items":[],"quickWins":[],"summary":{}}' > audit.json
          
          echo "critical=$(jq '.summary.critical // 0' audit.json)" >> $GITHUB_OUTPUT
          echo "high=$(jq '.summary.high // 0' audit.json)" >> $GITHUB_OUTPUT

      - name: Dead Code
        id: deadcode
        run: |
          ./ckb telemetry dead-code --threshold=0.9 --limit=5 --format=json > deadcode.json 2>/dev/null || echo '{"candidates":[]}' > deadcode.json
          echo "count=$(jq '.candidates | length' deadcode.json)" >> $GITHUB_OUTPUT

      - name: Docs
        id: docs
        run: |
          ./ckb docs index 2>/dev/null || true
          ./ckb docs coverage --format=json > docs-coverage.json 2>/dev/null || echo '{"coverage":0}' > docs-coverage.json
          ./ckb docs stale --all --format=json > docs-stale.json 2>/dev/null || echo '{"totalStale":0}' > docs-stale.json
          
          echo "coverage=$(jq '.coverage // 0' docs-coverage.json)" >> $GITHUB_OUTPUT
          echo "stale=$(jq '.totalStale // 0' docs-stale.json)" >> $GITHUB_OUTPUT

      - name: Drift
        run: |
          ./ckb ownership drift --threshold=0.3 --limit=5 --format=json > drift.json 2>/dev/null || echo '[]' > drift.json

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Report
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment
        uses: actions/github-script@v7
        env:
          CACHE_HIT: ${{ steps.cache.outputs.cache-hit }}
          INDEX_MODE: ${{ steps.index.outputs.mode }}
        with:
          script: |
            const fs = require('fs');
            const read = (f, d) => { try { return JSON.parse(fs.readFileSync(f)); } catch { return d; } };
            
            // Load data
            const pr = read('analysis.json', {});
            const complexity = read('complexity.json', []);
            const coupling = read('coupling.json', { missingCoupled: [] });
            const contracts = read('contracts.json', { files: [] });
            const audit = read('audit.json', { items: [], quickWins: [], summary: {} });
            const deadcode = read('deadcode.json', { candidates: [] });
            const docsCov = read('docs-coverage.json', { coverage: 0 });
            const docsStale = read('docs-stale.json', { totalStale: 0 });
            const drift = read('drift.json', []);
            
            const s = pr.summary || {};
            const risk = pr.riskAssessment || {};
            const reviewers = pr.suggestedReviewers || [];
            const modules = pr.modulesAffected || [];
            const hotspots = (pr.changedFiles || []).filter(f => f.isHotspot);
            
            // Helpers
            const bar = (v, m, w = 8) => '`' + 'â–ˆ'.repeat(Math.min(Math.round(v/m*w), w)) + 'â–‘'.repeat(Math.max(0, w - Math.round(v/m*w))) + '`';
            const pct = v => Math.round(v * 100);
            
            // Risk styling
            const riskStyle = {
              high: { icon: 'ğŸ”´', color: 'e74c3c', label: 'HIGH' },
              medium: { icon: 'ğŸŸ¡', color: 'f39c12', label: 'MEDIUM' },
              low: { icon: 'ğŸŸ¢', color: '27ae60', label: 'LOW' }
            }[risk.level] || { icon: 'âšª', color: '95a5a6', label: 'UNKNOWN' };
            
            // Build comment
            let md = [];
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // HEADER
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            md.push('## CKB Analysis');
            md.push('');
            md.push(`![Risk](https://img.shields.io/badge/${riskStyle.label}-${pct(risk.score || 0)}%25-${riskStyle.color}?style=for-the-badge) ` +
                    `![Files](https://img.shields.io/badge/Files-${s.totalFiles || 0}-3498db?style=flat-square) ` +
                    `![Lines](https://img.shields.io/badge/%2B${s.totalAdditions || 0}%20%2F%20âˆ’${s.totalDeletions || 0}-3498db?style=flat-square) ` +
                    `![Modules](https://img.shields.io/badge/Modules-${s.totalModules || 0}-3498db?style=flat-square)`);
            md.push('');
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // QUICK STATS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const stats = [];
            if (hotspots.length) stats.push(`ğŸ”¥ ${hotspots.length} hotspot${hotspots.length > 1 ? 's' : ''}`);
            if (audit.summary?.critical || audit.summary?.high) stats.push(`âš ï¸ ${(audit.summary.critical || 0) + (audit.summary.high || 0)} risk items`);
            const complexViolations = complexity.filter(c => c.cyclomatic > ${{ env.COMPLEXITY_CYCLOMATIC }} || c.cognitive > ${{ env.COMPLEXITY_COGNITIVE }});
            if (complexViolations.length) stats.push(`ğŸ“Š ${complexViolations.length} complex`);
            if (coupling.missingCoupled?.length) stats.push(`ğŸ”— ${coupling.missingCoupled.length} coupled`);
            if (contracts.files?.length) stats.push(`ğŸ“œ ${contracts.files.length} contract${contracts.files.length > 1 ? 's' : ''}`);
            if (docsStale.totalStale) stats.push(`ğŸ“š ${docsStale.totalStale} stale`);
            if (deadcode.candidates?.length) stats.push(`ğŸ’€ ${deadcode.candidates.length} dead`);
            
            if (stats.length) {
              md.push(`> ${stats.join(' Â· ')}`);
              md.push('');
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // RISK FACTORS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (risk.factors?.length) {
              md.push('**Risk factors:** ' + risk.factors.slice(0, 3).join(' â€¢ '));
              md.push('');
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // REVIEWERS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (reviewers.length) {
              const list = reviewers.slice(0, 3).map(r => `**${r.owner.replace(/^@?/, '@')}** (${pct(r.coverage)}%)`).join(', ');
              md.push(`ğŸ‘¥ Suggested: ${list}`);
              md.push('');
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // METRICS TABLE
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            md.push('| Metric | Value | |');
            md.push('|:-------|------:|:-:|');
            md.push(`| Doc Coverage | ${docsCov.coverage || 0}% | ${(docsCov.coverage || 0) >= ${{ env.DOC_COVERAGE_MIN }} ? 'âœ…' : 'âš ï¸'} |`);
            md.push(`| Complexity Issues | ${complexViolations.length} | ${complexViolations.length === 0 ? 'âœ…' : 'âš ï¸'} |`);
            md.push(`| Coupling Gaps | ${coupling.missingCoupled?.length || 0} | ${!coupling.missingCoupled?.length ? 'âœ…' : 'âš ï¸'} |`);
            md.push(`| Index | ${process.env.INDEX_MODE} | ${process.env.CACHE_HIT === 'true' ? 'ğŸ’¾' : 'ğŸ†•'} |`);
            md.push('');
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // DETAILS SECTIONS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // Risk Audit
            const critical = (audit.items || []).filter(i => i.riskLevel === 'critical');
            const high = (audit.items || []).filter(i => i.riskLevel === 'high');
            if (critical.length || high.length) {
              md.push('<details>');
              md.push(`<summary>âš ï¸ Risk Audit â€” ${critical.length} critical, ${high.length} high</summary>`);
              md.push('');
              md.push('| | File | Score | Factor |');
              md.push('|:-|:-----|------:|:-------|');
              [...critical, ...high].slice(0, 6).forEach(i => {
                const icon = i.riskLevel === 'critical' ? 'ğŸ”´' : 'ğŸŸ ';
                md.push(`| ${icon} | \`${i.file}\` | ${i.riskScore} | ${i.factors?.[0]?.factor || 'â€”'} |`);
              });
              md.push('');
              md.push('</details>');
              md.push('');
            }
            
            // Hotspots
            if (hotspots.length) {
              md.push('<details>');
              md.push(`<summary>ğŸ”¥ Hotspots â€” ${hotspots.length} volatile</summary>`);
              md.push('');
              md.push('| File | Churn |');
              md.push('|:-----|------:|');
              hotspots.slice(0, 5).forEach(f => {
                md.push(`| \`${f.path}\` | ${bar(f.hotspotScore || 0, 1)} ${(f.hotspotScore || 0).toFixed(2)} |`);
              });
              md.push('');
              md.push('</details>');
              md.push('');
            }
            
            // Modules
            const riskyMods = modules.filter(m => m.riskLevel === 'high' || m.riskLevel === 'medium');
            if (riskyMods.length) {
              md.push('<details>');
              md.push(`<summary>ğŸ“¦ Modules â€” ${riskyMods.length} at risk</summary>`);
              md.push('');
              md.push('| | Module | Files |');
              md.push('|:-|:-------|------:|');
              riskyMods.slice(0, 5).forEach(m => {
                const icon = m.riskLevel === 'high' ? 'ğŸ”´' : 'ğŸŸ¡';
                md.push(`| ${icon} | \`${m.moduleId}\` | ${m.filesChanged} |`);
              });
              md.push('');
              md.push('</details>');
              md.push('');
            }
            
            // Contracts
            if (contracts.files?.length) {
              md.push('<details>');
              md.push(`<summary>ğŸ“œ Contracts â€” ${contracts.files.length} changed</summary>`);
              md.push('');
              contracts.files.forEach(f => md.push(`- \`${f}\``));
              md.push('');
              md.push('</details>');
              md.push('');
            }
            
            // Quick Wins
            if (audit.quickWins?.length) {
              md.push('<details>');
              md.push(`<summary>ğŸ’¡ Quick Wins â€” ${audit.quickWins.length} suggestions</summary>`);
              md.push('');
              audit.quickWins.slice(0, 5).forEach(w => {
                const e = { low: 'ğŸŸ¢', medium: 'ğŸŸ¡', high: 'ğŸ”´' }[w.effort] || 'âšª';
                md.push(`- ${e} **${w.action}** â†’ \`${w.target}\``);
              });
              md.push('');
              md.push('</details>');
              md.push('');
            }
            
            // Complexity
            if (complexViolations.length) {
              md.push('<details>');
              md.push(`<summary>ğŸ“Š Complexity â€” ${complexViolations.length} violations</summary>`);
              md.push('');
              md.push('| File | Cyclomatic | Cognitive |');
              md.push('|:-----|----------:|-----------:|');
              complexViolations.slice(0, 5).forEach(c => {
                const cyWarn = c.cyclomatic > ${{ env.COMPLEXITY_CYCLOMATIC }} ? 'âš ï¸ ' : '';
                const cgWarn = c.cognitive > ${{ env.COMPLEXITY_COGNITIVE }} ? 'âš ï¸ ' : '';
                md.push(`| \`${c.file}\` | ${cyWarn}${c.cyclomatic} | ${cgWarn}${c.cognitive} |`);
              });
              md.push('');
              md.push('</details>');
              md.push('');
            }
            
            // Coupling
            if (coupling.missingCoupled?.length) {
              md.push('<details>');
              md.push(`<summary>ğŸ”— Coupling â€” ${coupling.missingCoupled.length} missing</summary>`);
              md.push('');
              md.push('| Missing | Usually with | Score |');
              md.push('|:--------|:-------------|------:|');
              coupling.missingCoupled.slice(0, 5).forEach(c => {
                md.push(`| \`${c.file}\` | \`${c.coupledTo}\` | ${pct(c.correlation || c.couplingScore || 0)}% |`);
              });
              md.push('');
              md.push('</details>');
              md.push('');
            }
            
            // Ownership Drift
            if (drift.length) {
              md.push('<details>');
              md.push(`<summary>ğŸ‘¤ Ownership Drift â€” ${drift.length} files</summary>`);
              md.push('');
              md.push('| File | Declared | Actual |');
              md.push('|:-----|:---------|:-------|');
              drift.slice(0, 5).forEach(d => {
                md.push(`| \`${d.path}\` | ${d.declaredOwner || 'â€”'} | ${d.actualOwner || 'â€”'} |`);
              });
              md.push('');
              md.push('</details>');
              md.push('');
            }
            
            // Dead Code
            if (deadcode.candidates?.length) {
              md.push('<details>');
              md.push(`<summary>ğŸ’€ Dead Code â€” ${deadcode.candidates.length} candidates</summary>`);
              md.push('');
              md.push('| Symbol | Confidence |');
              md.push('|:-------|:-----------|');
              deadcode.candidates.slice(0, 5).forEach(c => {
                md.push(`| \`${c.name}\` | ${bar(c.confidence || 0, 1, 6)} ${pct(c.confidence || 0)}% |`);
              });
              md.push('');
              md.push('</details>');
              md.push('');
            }
            
            // Stale Docs
            if (docsStale.totalStale) {
              md.push('<details>');
              md.push(`<summary>ğŸ“š Stale Docs â€” ${docsStale.totalStale} references</summary>`);
              md.push('');
              (docsStale.reports || []).slice(0, 3).forEach(r => {
                (r.stale || []).slice(0, 2).forEach(s => {
                  md.push(`- \`${r.docPath}:${s.line}\` â€” ${s.rawText}`);
                });
              });
              md.push('');
              md.push('</details>');
              md.push('');
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // FOOTER
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            md.push('---');
            md.push('<sub>Generated by <a href="https://github.com/SimplyLiz/CodeMCP">CKB</a></sub>');
            
            // Post/update comment
            const body = '<!-- ckb -->\n' + md.join('\n');
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const existing = comments.find(c => c.body?.includes('<!-- ckb -->'));
            
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Auto-Assign Reviewers
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Reviewers
        if: always()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const { suggestedReviewers = [] } = JSON.parse(fs.readFileSync('analysis.json'));
              const reviewers = suggestedReviewers
                .map(r => r.owner.replace(/^@/, ''))
                .filter(r => !r.includes('/') && r !== context.actor)
                .slice(0, 2);
              
              if (reviewers.length) {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  reviewers
                });
              }
            } catch {}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Artifacts
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Save Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-${{ hashFiles('go.sum') }}-${{ github.base_ref }}

      - name: Upload
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ckb-analysis
          path: '*.json'
          retention-days: 7

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘ SCHEDULED REFRESH                                                        â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  refresh:
    name: Refresh
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Build
        run: go build -ldflags="-s -w" -o ckb ./cmd/ckb

      - name: Install SCIP indexer
        run: go install github.com/sourcegraph/scip-go/cmd/scip-go@latest

      - name: Cache
        uses: actions/cache@v4
        with:
          path: .ckb/
          key: ckb-${{ runner.os }}-refresh-${{ github.run_id }}
          restore-keys: ckb-${{ runner.os }}-

      - name: Refresh
        run: |
          ./ckb init

          # Check for language-specific indexer
          if ! ./ckb index --force 2>&1 | tee /tmp/index.log; then
            if grep -q "Indexer not found" /tmp/index.log; then
              echo "::error::SCIP indexer not installed. See install commands below."
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  INDEXER NOT FOUND                                                            â•‘"
              echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
              echo "â•‘  CKB requires a SCIP indexer for your language.                               â•‘"
              echo "â•‘                                                                               â•‘"
              echo "â•‘  Go:         go install github.com/sourcegraph/scip-go/cmd/scip-go@latest     â•‘"
              echo "â•‘  TypeScript: npm i -g @sourcegraph/scip-typescript                            â•‘"
              echo "â•‘  Python:     pip install scip-python                                          â•‘"
              echo "â•‘  Rust:       cargo install scip                                               â•‘"
              echo "â•‘                                                                               â•‘"
              echo "â•‘  Add the install step before 'ckb index' in your workflow.                    â•‘"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              exit 1
            fi
            echo "::error::Indexing failed. Check logs above."
            exit 1
          fi

          mkdir -p reports
          ./ckb hotspots --limit=50 --format=json > reports/hotspots.json 2>/dev/null || true
          ./ckb audit --min-score=40 --limit=50 --format=json > reports/audit.json 2>/dev/null || true
          ./ckb ownership drift --format=json > reports/drift.json 2>/dev/null || true

      - name: Summary
        run: |
          echo "## ğŸ“Š CKB Refresh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------:|" >> $GITHUB_STEP_SUMMARY
          echo "| Hotspots | $(jq 'length' reports/hotspots.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $(jq '.summary.critical // 0' reports/audit.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| High Risk | $(jq '.summary.high // 0' reports/audit.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| Drift | $(jq 'if type == "array" then length else 0 end' reports/drift.json 2>/dev/null || echo 0) |" >> $GITHUB_STEP_SUMMARY

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ckb-refresh
          path: reports/
          retention-days: 30