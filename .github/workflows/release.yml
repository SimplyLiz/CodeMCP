name: Release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel releases

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Run tests
        run: go test -race ./...

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download checksums
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          # Wait for release assets to be available
          sleep 10
          curl -sLO "https://github.com/SimplyLiz/CodeMCP/releases/download/v${VERSION}/checksums.txt"

      - name: Publish npm packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Publishing version $VERSION"

          # Update version in package.json
          cd npm
          npm version $VERSION --no-git-tag-version --allow-same-version

          # Update optionalDependencies versions
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            for (const dep of Object.keys(pkg.optionalDependencies || {})) {
              pkg.optionalDependencies[dep] = '$VERSION';
            }
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # Publish main package (prepublishOnly copies README.md and LICENSE)
          if ! npm publish --access public 2>&1 | tee /tmp/npm-publish.log; then
            if grep -q "already exists" /tmp/npm-publish.log; then
              echo "::warning::Main package version already exists, skipping"
            else
              echo "::error::Failed to publish main package"
              exit 1
            fi
          fi

          cd ..

          # Create and publish platform packages
          PLATFORMS="darwin-arm64 darwin-x64 linux-x64 linux-arm64 win32-x64"

          for PLATFORM in $PLATFORMS; do
            echo "Creating package for $PLATFORM"

            # Map platform to goreleaser naming
            case $PLATFORM in
              darwin-arm64) ARCHIVE="ckb_${VERSION}_darwin_arm64.tar.gz" ;;
              darwin-x64)   ARCHIVE="ckb_${VERSION}_darwin_amd64.tar.gz" ;;
              linux-x64)    ARCHIVE="ckb_${VERSION}_linux_amd64.tar.gz" ;;
              linux-arm64)  ARCHIVE="ckb_${VERSION}_linux_arm64.tar.gz" ;;
              win32-x64)    ARCHIVE="ckb_${VERSION}_windows_amd64.zip" ;;
            esac

            PKG_NAME="@tastehub/ckb-${PLATFORM}"
            PKG_DIR="npm-${PLATFORM}"

            mkdir -p "$PKG_DIR/bin"

            # Download from GitHub release
            curl -sfL "https://github.com/SimplyLiz/CodeMCP/releases/download/v${VERSION}/${ARCHIVE}" -o "$ARCHIVE"

            # Verify checksum
            if ! grep "$ARCHIVE" checksums.txt | sha256sum -c -; then
              echo "::error::Checksum verification failed for $ARCHIVE"
              exit 1
            fi

            # Extract
            if [[ $PLATFORM == win32-x64 ]]; then
              unzip -q "$ARCHIVE" -d "$PKG_DIR/bin"
            else
              tar xzf "$ARCHIVE" -C "$PKG_DIR/bin"
            fi

            # Create package.json
            cat > "$PKG_DIR/package.json" << EOF
          {
            "name": "${PKG_NAME}",
            "version": "${VERSION}",
            "description": "CKB binary for ${PLATFORM}",
            "os": ["${PLATFORM%-*}"],
            "cpu": ["${PLATFORM#*-}"],
            "files": ["bin"],
            "license": "MIT"
          }
          EOF

            # Publish
            cd "$PKG_DIR"
            if ! npm publish --access public 2>&1 | tee /tmp/npm-publish.log; then
              if grep -q "already exists" /tmp/npm-publish.log; then
                echo "::warning::Package $PKG_NAME version already exists, skipping"
              else
                echo "::error::Failed to publish $PKG_NAME"
                exit 1
              fi
            fi
            cd ..
          done
