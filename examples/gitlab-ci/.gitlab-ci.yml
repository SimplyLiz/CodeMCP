# CKB GitLab CI Configuration
# Complete pipeline for code analysis with CKB
#
# Usage: Copy to .gitlab-ci.yml or include in your existing config

stages:
  - setup
  - analyze
  - report

variables:
  CKB_VERSION: "latest"
  CKB_CACHE_DIR: ".ckb"
  RISK_THRESHOLD: "critical"
  MAX_CYCLOMATIC: "15"
  MAX_COGNITIVE: "20"

# Cache configuration for faster subsequent runs
.ckb-cache: &ckb-cache
  cache:
    key: ckb-${CI_COMMIT_REF_SLUG}
    paths:
      - ${CKB_CACHE_DIR}/
    policy: pull-push

# Base job configuration
.ckb-base:
  image: node:20-alpine
  before_script:
    - apk add --no-cache git curl jq
    - npm install -g @tastehub/ckb@${CKB_VERSION}
    - ckb init
  <<: *ckb-cache

# Index the repository
index:
  stage: setup
  extends: .ckb-base
  script:
    - ckb index --if-stale=24h
  artifacts:
    paths:
      - ${CKB_CACHE_DIR}/
    expire_in: 1 day

# Impact analysis for merge requests
impact-analysis:
  stage: analyze
  extends: .ckb-base
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs:
    - index
  script:
    - |
      # Get merge request diff range
      BASE_SHA="${CI_MERGE_REQUEST_DIFF_BASE_SHA}"
      HEAD_SHA="${CI_COMMIT_SHA}"

      # Run impact analysis
      ckb impact --range="${BASE_SHA}..${HEAD_SHA}" --format=json > impact.json

      # Extract metrics
      RISK=$(jq -r '.summary.estimatedRisk // "low"' impact.json)
      FILES=$(jq -r '.summary.filesChanged // 0' impact.json)
      AFFECTED=$(jq -r '.summary.transitivelyAffected // 0' impact.json)

      echo "Risk Level: $RISK"
      echo "Files Changed: $FILES"
      echo "Transitively Affected: $AFFECTED"

      # Generate markdown for MR note
      ckb impact --range="${BASE_SHA}..${HEAD_SHA}" --format=markdown > impact.md

      # Fail on critical risk
      if [ "$RISK" = "${RISK_THRESHOLD}" ]; then
        echo "ERROR: Risk level $RISK exceeds threshold"
        exit 1
      fi
  artifacts:
    paths:
      - impact.json
      - impact.md
    reports:
      dotenv: impact.env
    expire_in: 1 week

# Complexity checking
complexity-check:
  stage: analyze
  extends: .ckb-base
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs:
    - index
  script:
    - |
      VIOLATIONS=0

      # Get changed files
      git diff --name-only ${CI_MERGE_REQUEST_DIFF_BASE_SHA}..${CI_COMMIT_SHA} \
        | grep -E '\.(go|ts|tsx|js|jsx|py|rs|java)$' > changed-files.txt || true

      echo "## Complexity Report" > complexity.md
      echo "" >> complexity.md

      if [ -s changed-files.txt ]; then
        echo "| File | Cyclomatic | Cognitive | Status |" >> complexity.md
        echo "|------|------------|-----------|--------|" >> complexity.md

        while IFS= read -r file; do
          if [ -f "$file" ]; then
            RESULT=$(ckb complexity "$file" --format=json 2>/dev/null || echo '{}')
            CYCLO=$(echo "$RESULT" | jq -r '.metrics.cyclomaticComplexity // 0')
            COGNITIVE=$(echo "$RESULT" | jq -r '.metrics.cognitiveComplexity // 0')

            STATUS="✅"
            if [ "$CYCLO" -gt "${MAX_CYCLOMATIC}" ] || [ "$COGNITIVE" -gt "${MAX_COGNITIVE}" ]; then
              STATUS="❌"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi

            echo "| \`$file\` | $CYCLO | $COGNITIVE | $STATUS |" >> complexity.md
          fi
        done < changed-files.txt
      else
        echo "No source files changed." >> complexity.md
      fi

      echo "" >> complexity.md
      echo "**Thresholds:** Cyclomatic: ${MAX_CYCLOMATIC}, Cognitive: ${MAX_COGNITIVE}" >> complexity.md

      if [ "$VIOLATIONS" -gt 0 ]; then
        echo "ERROR: $VIOLATIONS complexity violations found"
        exit 1
      fi
  artifacts:
    paths:
      - complexity.md
    expire_in: 1 week

# Get suggested reviewers
suggest-reviewers:
  stage: analyze
  extends: .ckb-base
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs:
    - index
  script:
    - |
      BASE_SHA="${CI_MERGE_REQUEST_DIFF_BASE_SHA}"
      HEAD_SHA="${CI_COMMIT_SHA}"

      # Get reviewers as JSON
      ckb reviewers --range="${BASE_SHA}..${HEAD_SHA}" --format=json > reviewers.json

      # Display suggested reviewers
      echo "## Suggested Reviewers"
      jq -r '.reviewers[] | "- \(.owner): \(.reason)"' reviewers.json
  artifacts:
    paths:
      - reviewers.json
    expire_in: 1 week

# Hotspot analysis
hotspot-check:
  stage: analyze
  extends: .ckb-base
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs:
    - index
  script:
    - |
      # Get current hotspots
      ckb hotspots --limit=30 --format=json > hotspots.json

      # Check if MR touches any hotspots
      git diff --name-only ${CI_MERGE_REQUEST_DIFF_BASE_SHA}..${CI_COMMIT_SHA} > changed-files.txt

      echo "## Hotspot Warning" > hotspots.md
      echo "" >> hotspots.md

      TOUCHED=0
      while IFS= read -r file; do
        SCORE=$(jq -r --arg f "$file" '.hotspots[] | select(.filePath == $f) | .ranking.score // empty' hotspots.json)
        if [ -n "$SCORE" ]; then
          echo "- \`$file\` (score: $SCORE)" >> hotspots.md
          TOUCHED=$((TOUCHED + 1))
        fi
      done < changed-files.txt

      if [ "$TOUCHED" -gt 0 ]; then
        echo "" >> hotspots.md
        echo "**Warning:** This MR modifies $TOUCHED hotspot file(s). Extra review recommended." >> hotspots.md
      else
        echo "No hotspot files touched." >> hotspots.md
      fi
  artifacts:
    paths:
      - hotspots.json
      - hotspots.md
    expire_in: 1 week

# Post MR notes (requires API token)
post-mr-notes:
  stage: report
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs:
    - impact-analysis
    - complexity-check
    - hotspot-check
  before_script:
    - apk add --no-cache curl
  script:
    - |
      # Combine reports
      cat > combined-report.md << 'EOF'
      # CKB Analysis Report

      EOF

      cat impact.md >> combined-report.md
      echo "" >> combined-report.md
      cat complexity.md >> combined-report.md
      echo "" >> combined-report.md
      cat hotspots.md >> combined-report.md

      # Post as MR note (requires GITLAB_TOKEN with api scope)
      if [ -n "${GITLAB_TOKEN}" ]; then
        BODY=$(cat combined-report.md | jq -Rs .)
        curl --silent --request POST \
          --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
          --header "Content-Type: application/json" \
          --data "{\"body\": ${BODY}}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes"
      else
        echo "GITLAB_TOKEN not set, skipping MR note"
        cat combined-report.md
      fi
  artifacts:
    paths:
      - combined-report.md
    expire_in: 1 week

# Scheduled architecture refresh
architecture-refresh:
  stage: analyze
  extends: .ckb-base
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - |
      # Force full index
      ckb index --force

      # Get architecture summary
      ckb architecture --format=json > architecture.json

      # Get hotspots
      ckb hotspots --limit=50 --format=json > hotspots.json

      # Get dead code candidates
      ckb dead-code --threshold=0.9 --limit=30 --format=json > dead-code.json

      echo "Architecture refresh complete"
      echo "Modules: $(jq -r '.modules | length' architecture.json)"
      echo "Hotspots: $(jq -r '.hotspots | length' hotspots.json)"
      echo "Dead code candidates: $(jq -r '.candidates | length' dead-code.json)"
  artifacts:
    paths:
      - architecture.json
      - hotspots.json
      - dead-code.json
    expire_in: 30 days
  cache:
    key: ckb-main
    paths:
      - ${CKB_CACHE_DIR}/
    policy: push
