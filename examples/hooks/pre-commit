#!/bin/bash
# CKB Pre-commit Hook
# Blocks commits with critical risk or complexity violations
#
# Installation:
#   cp examples/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or with pre-commit framework (see .pre-commit-config.yaml)

set -e

# Configuration
MAX_CYCLOMATIC=${CKB_MAX_CYCLOMATIC:-15}
MAX_COGNITIVE=${CKB_MAX_COGNITIVE:-20}
BLOCK_CRITICAL=${CKB_BLOCK_CRITICAL:-true}
WARN_HIGH=${CKB_WARN_HIGH:-true}

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Check if ckb is installed
if ! command -v ckb &> /dev/null; then
    echo -e "${YELLOW}Warning: CKB not installed, skipping analysis${NC}"
    exit 0
fi

echo "Running CKB pre-commit checks..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(go|ts|tsx|js|jsx|py|rs|java)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No source files staged, skipping checks${NC}"
    exit 0
fi

ERRORS=0
WARNINGS=0

# Check complexity for each staged file
echo ""
echo "Checking complexity..."
while IFS= read -r file; do
    if [ -f "$file" ]; then
        RESULT=$(ckb complexity "$file" --format=json 2>/dev/null || echo '{}')
        CYCLO=$(echo "$RESULT" | jq -r '.metrics.cyclomaticComplexity // 0')
        COGNITIVE=$(echo "$RESULT" | jq -r '.metrics.cognitiveComplexity // 0')

        if [ "$CYCLO" -gt "$MAX_CYCLOMATIC" ]; then
            echo -e "${RED}ERROR: $file has cyclomatic complexity $CYCLO (max: $MAX_CYCLOMATIC)${NC}"
            ERRORS=$((ERRORS + 1))
        elif [ "$CYCLO" -gt $((MAX_CYCLOMATIC - 3)) ]; then
            echo -e "${YELLOW}Warning: $file has cyclomatic complexity $CYCLO (approaching limit)${NC}"
            WARNINGS=$((WARNINGS + 1))
        fi

        if [ "$COGNITIVE" -gt "$MAX_COGNITIVE" ]; then
            echo -e "${RED}ERROR: $file has cognitive complexity $COGNITIVE (max: $MAX_COGNITIVE)${NC}"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done <<< "$STAGED_FILES"

# Check impact risk for staged changes
echo ""
echo "Checking change impact..."
IMPACT=$(ckb impact diff --staged --format=json 2>/dev/null || echo '{"summary":{"estimatedRisk":"unknown"}}')
RISK=$(echo "$IMPACT" | jq -r '.summary.estimatedRisk // "unknown"')

case "$RISK" in
    critical)
        if [ "$BLOCK_CRITICAL" = "true" ]; then
            echo -e "${RED}ERROR: Staged changes have CRITICAL risk level${NC}"
            echo "This commit affects critical code paths and requires extra review."
            echo ""
            echo "To bypass this check (not recommended):"
            echo "  git commit --no-verify"
            echo ""
            echo "Or reduce the scope of your changes."
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${YELLOW}Warning: Staged changes have critical risk level${NC}"
            WARNINGS=$((WARNINGS + 1))
        fi
        ;;
    high)
        if [ "$WARN_HIGH" = "true" ]; then
            echo -e "${YELLOW}Warning: Staged changes have HIGH risk level${NC}"
            WARNINGS=$((WARNINGS + 1))
        fi
        ;;
    medium)
        echo -e "${GREEN}Risk level: medium${NC}"
        ;;
    low)
        echo -e "${GREEN}Risk level: low${NC}"
        ;;
    *)
        echo "Risk level: unknown (indexing may be needed)"
        ;;
esac

# Check for hotspot modifications
echo ""
echo "Checking hotspots..."
HOTSPOTS=$(ckb hotspots --limit=20 --format=json 2>/dev/null || echo '{"hotspots":[]}')

HOTSPOT_TOUCHED=0
while IFS= read -r file; do
    SCORE=$(echo "$HOTSPOTS" | jq -r --arg f "$file" '.hotspots[] | select(.filePath == $f) | .ranking.score // empty')
    if [ -n "$SCORE" ]; then
        if (( $(echo "$SCORE > 0.8" | bc -l 2>/dev/null || echo 0) )); then
            echo -e "${YELLOW}Warning: Modifying high-risk hotspot: $file (score: $SCORE)${NC}"
            HOTSPOT_TOUCHED=$((HOTSPOT_TOUCHED + 1))
        fi
    fi
done <<< "$STAGED_FILES"

if [ "$HOTSPOT_TOUCHED" -gt 0 ]; then
    WARNINGS=$((WARNINGS + HOTSPOT_TOUCHED))
fi

# Summary
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
if [ "$ERRORS" -gt 0 ]; then
    echo -e "${RED}Pre-commit check FAILED${NC}"
    echo "  Errors: $ERRORS"
    echo "  Warnings: $WARNINGS"
    echo ""
    echo "Fix the errors above or use 'git commit --no-verify' to bypass."
    exit 1
elif [ "$WARNINGS" -gt 0 ]; then
    echo -e "${YELLOW}Pre-commit check PASSED with warnings${NC}"
    echo "  Warnings: $WARNINGS"
    echo ""
    echo "Consider addressing the warnings above."
    exit 0
else
    echo -e "${GREEN}Pre-commit check PASSED${NC}"
    exit 0
fi
