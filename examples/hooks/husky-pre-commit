#!/bin/sh
# CKB Husky Pre-commit Hook
# For JavaScript/TypeScript projects using Husky
#
# Installation:
#   npm install -D husky lint-staged
#   npx husky init
#   cp examples/hooks/husky-pre-commit .husky/pre-commit
#   chmod +x .husky/pre-commit

. "$(dirname "$0")/_/husky.sh"

# Run lint-staged for linting/formatting
npx lint-staged

# Run CKB impact analysis if available
if command -v ckb &> /dev/null; then
  echo "Running CKB analysis..."

  RESULT=$(ckb impact diff --staged --format=json 2>/dev/null || echo '{}')
  RISK=$(echo "$RESULT" | node -e "
    const d=require('fs').readFileSync('/dev/stdin','utf8');
    const j=JSON.parse(d||'{}');
    console.log(j.summary?.estimatedRisk||'unknown')
  ")

  if [ "$RISK" = "critical" ]; then
    echo ""
    echo "⛔ CKB detected CRITICAL risk in staged changes"
    echo ""
    echo "   Run 'ckb impact diff --staged' for details"
    echo "   Bypass with: git commit --no-verify"
    echo ""
    exit 1
  elif [ "$RISK" = "high" ]; then
    echo ""
    echo "⚠️  CKB detected HIGH risk in staged changes"
    echo "   Consider running full test suite before pushing."
    echo ""
  fi
fi
