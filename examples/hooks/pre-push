#!/bin/bash
# CKB Pre-push Hook
# Validates branch before pushing, checking for critical issues
#
# Installation:
#   cp examples/hooks/pre-push .git/hooks/pre-push
#   chmod +x .git/hooks/pre-push

set -e

# Configuration
BLOCK_CRITICAL=${CKB_BLOCK_CRITICAL:-true}
RUN_DEAD_CODE=${CKB_RUN_DEAD_CODE:-false}

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# Check if ckb is installed
if ! command -v ckb &> /dev/null; then
    echo -e "${YELLOW}Warning: CKB not installed, skipping analysis${NC}"
    exit 0
fi

# Read stdin for ref info
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Deleting branch, skip
        continue
    fi

    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch, compare against main/master
        MAIN_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "main")
        remote_sha=$(git rev-parse "origin/$MAIN_BRANCH" 2>/dev/null || echo "")
    fi

    if [ -z "$remote_sha" ]; then
        echo -e "${YELLOW}Warning: Cannot determine base commit, skipping analysis${NC}"
        continue
    fi

    echo "Analyzing changes from $remote_sha to $local_sha..."
    echo ""

    # Impact analysis
    IMPACT=$(ckb impact --range="${remote_sha}..${local_sha}" --format=json 2>/dev/null || echo '{}')
    RISK=$(echo "$IMPACT" | jq -r '.summary.estimatedRisk // "unknown"')
    FILES=$(echo "$IMPACT" | jq -r '.summary.filesChanged // 0')
    AFFECTED=$(echo "$IMPACT" | jq -r '.summary.transitivelyAffected // 0')

    echo "Summary:"
    echo "  Files changed: $FILES"
    echo "  Transitively affected: $AFFECTED"
    echo "  Risk level: $RISK"
    echo ""

    # Check for critical risk
    if [ "$RISK" = "critical" ] && [ "$BLOCK_CRITICAL" = "true" ]; then
        echo -e "${RED}ERROR: Push contains critical-risk changes${NC}"
        echo ""
        echo "This push would affect critical code paths."
        echo "Please ensure these changes have been reviewed."
        echo ""
        echo "To push anyway:"
        echo "  git push --no-verify"
        exit 1
    fi

    # Optional dead code check
    if [ "$RUN_DEAD_CODE" = "true" ]; then
        echo "Checking for dead code..."
        DEAD=$(ckb dead-code --threshold=0.95 --limit=5 --format=json 2>/dev/null || echo '{"candidates":[]}')
        COUNT=$(echo "$DEAD" | jq -r '.candidates | length')

        if [ "$COUNT" -gt 0 ]; then
            echo -e "${YELLOW}Warning: $COUNT potential dead code candidates found${NC}"
            echo "$DEAD" | jq -r '.candidates[] | "  - \(.file):\(.symbol)"'
        fi
    fi

    echo -e "${GREEN}Pre-push check passed${NC}"
done

exit 0
