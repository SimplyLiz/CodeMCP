# CKB Pre-commit Framework Configuration
# Use with https://pre-commit.com/
#
# Installation:
#   pip install pre-commit
#   cp examples/hooks/.pre-commit-config.yaml .pre-commit-config.yaml
#   pre-commit install

repos:
  # CKB complexity check
  - repo: local
    hooks:
      - id: ckb-complexity
        name: CKB Complexity Check
        description: Check code complexity thresholds
        entry: bash -c '
          MAX_CYCLO=${CKB_MAX_CYCLOMATIC:-15}
          MAX_COGN=${CKB_MAX_COGNITIVE:-20}
          ERRORS=0
          for file in "$@"; do
            if [ -f "$file" ]; then
              RESULT=$(ckb complexity "$file" --format=json 2>/dev/null || echo "{}")
              CYCLO=$(echo "$RESULT" | jq -r ".metrics.cyclomaticComplexity // 0")
              COGN=$(echo "$RESULT" | jq -r ".metrics.cognitiveComplexity // 0")
              if [ "$CYCLO" -gt "$MAX_CYCLO" ]; then
                echo "ERROR: $file cyclomatic=$CYCLO (max: $MAX_CYCLO)"
                ERRORS=$((ERRORS + 1))
              fi
              if [ "$COGN" -gt "$MAX_COGN" ]; then
                echo "ERROR: $file cognitive=$COGN (max: $MAX_COGN)"
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done
          exit $ERRORS
        '
        language: system
        types_or: [go, javascript, typescript, python, rust, java]
        pass_filenames: true

      - id: ckb-impact
        name: CKB Impact Analysis
        description: Warn on high-risk changes
        entry: bash -c '
          IMPACT=$(ckb impact diff --staged --format=json 2>/dev/null || echo "{}")
          RISK=$(echo "$IMPACT" | jq -r ".summary.estimatedRisk // \"unknown\"")
          if [ "$RISK" = "critical" ]; then
            echo "ERROR: Staged changes have CRITICAL risk"
            exit 1
          elif [ "$RISK" = "high" ]; then
            echo "WARNING: Staged changes have HIGH risk"
          fi
        '
        language: system
        pass_filenames: false
        always_run: true
        stages: [commit]

      - id: ckb-hotspot-warn
        name: CKB Hotspot Warning
        description: Warn when modifying hotspot files
        entry: bash -c '
          HOTSPOTS=$(ckb hotspots --limit=20 --format=json 2>/dev/null || echo "{\"hotspots\":[]}")
          for file in "$@"; do
            SCORE=$(echo "$HOTSPOTS" | jq -r --arg f "$file" ".hotspots[] | select(.filePath == \$f) | .ranking.score // empty")
            if [ -n "$SCORE" ]; then
              echo "WARNING: Modifying hotspot: $file (score: $SCORE)"
            fi
          done
        '
        language: system
        types_or: [go, javascript, typescript, python, rust, java]
        pass_filenames: true
        verbose: true

# Optional: Add standard linters alongside CKB
# - repo: https://github.com/pre-commit/pre-commit-hooks
#   rev: v4.5.0
#   hooks:
#     - id: trailing-whitespace
#     - id: end-of-file-fixer
#     - id: check-yaml
#     - id: check-added-large-files
